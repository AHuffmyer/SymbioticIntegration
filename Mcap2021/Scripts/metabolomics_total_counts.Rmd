---
title: Montipora capitata 2021 thermal stress metabolomics analysis
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("factoextra" %in% rownames(installed.packages()) == 'FALSE') install.packages('factoextra') 
if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify') 
if ("naniar" %in% rownames(installed.packages()) == 'FALSE') install.packages('naniar') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics") 
if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire') 
if ("VennDiagram" %in% rownames(installed.packages()) == 'FALSE') install.packages('VennDiagram') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 

#load packages
library("ggplot2")
library('vegan')
library('factoextra')
library('ggfortify')
library('naniar')
library('cowplot')
library("mixOmics")
library("tidyverse")
library("RVAideMemoire")
library("VennDiagram")
library("broom")

```

This script processes and prepares metabolomics data for analysis and conducts multivariate visualizations. This script is modified from A. Huffmyer Early Life History energetics script at https://github.com/AHuffmyer/EarlyLifeHistory_Energetics.   

# Data processing and exploration  

## Total ion Counts   

First load data for ion counts of each metabolite.  
```{r}
#load data
counts<-read.csv("Mcap2021/Data/Metabolomics/Peaks_Neg.csv", sep=",", na.strings=NA, header=TRUE)
``` 
  
Conduct normalization of samples by normalizing each metabolite ion count to the median ion count across metabolites within that sample.  

```{r}
counts <- counts %>%
  mutate(across(X12C_Ambient.A1_I7:Dark.13C_High.Pool_I40, ~ .x / median(.x, na.rm = TRUE))) #normalize the ion counts to the columns median to account for any variation in larval number in each sample 
```

Mutate the data to be in long rather than wide format and keep only relevant columns.  

```{r}
counts <- counts %>% 
  pivot_longer(names_to = "sample", values_to= "ion.count.norm", X12C_Ambient.A1_I7:Dark.13C_High.Pool_I40)%>%
  select(c(isotopeLabel, compound, sample, ion.count.norm))

```

Add metadata column with isotope, treatment, tank, and tube ID. 
```{r}
counts<-counts%>%
  separate(sample, c("isotope", "treatment","tube"), sep="_", remove = FALSE)%>%
  mutate(isotope=str_extract(isotope, "[^X]+$"))%>% #remove X from column
  mutate(sample=str_extract(sample, "[^X]+$"))%>% #remove X from column
  separate(treatment, c("treatment", "tank"))

#convert to factors 
counts$isotope<-as.factor(counts$isotope)
counts$treatment<-as.factor(counts$treatment)
counts$tank<-as.factor(counts$tank)
counts$tube<-as.factor(counts$tube)
counts$compound<-as.factor(counts$compound)
```

Sum together the ion counts for each isotope labeled fraction (C12 + C13-1 + C13-2 and so on). 
```{r}
total_counts<-counts%>%
  group_by(compound, sample, isotope, treatment, tank, tube)%>%
  summarise(total.ion.count=sum(ion.count.norm))
```

Create plot showing total normalized ion counts (count / sample median) for each treatment.   
```{r}
#make summary table
data_plotting<-plyr::ddply(total_counts, c("treatment", "compound"), summarise,
                N    = length(total.ion.count[!is.na(total.ion.count)]),
                mean = mean(total.ion.count, na.rm=TRUE),
                sd   = sd(total.ion.count, na.rm=TRUE),
                se   = sd / sqrt(N)
)

data_plotting<-data_plotting%>%arrange(compound)

metab_compounds<-ggplot(data_plotting, aes(y=mean, x=compound, fill=treatment, group=treatment)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolites")+
  ylab("Normalized Ion Count")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds

```

This plot is not very useful due to high ion counts for some metabolites. We will proceed to multivariate visualizations for total ion counts.   

## PCA  

For each compound there are C12 parent and then C13 1, 2, 3 etc for the number of carbons. How do we get total metabolite abundance from this? Do we just select the C12 parent? Do we sum them all together? Summing all together for now. 

Convert data to wide format.

```{r}
counts_pca<-total_counts%>%
  pivot_wider(names_from=compound, values_from=total.ion.count)
```

Generate a scaled data frame. 

```{r}
scaled.pca<-prcomp(counts_pca[c(6:97)],scale=TRUE, center=TRUE) 
```

Plot PCA by isotope treatment. 
```{r}
pcaPlot1<-ggplot2::autoplot(scaled.pca, data=counts_pca, frame.colour="isotope", loadings=FALSE, colour="isotope", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  theme_classic()+
  scale_colour_manual(values=c("gray", "green", "blue"))+
  scale_fill_manual(values=c("gray", "green", "blue"))+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1

ggsave("Mcap2021/Figures/Metabolomics/pca_isotope.jpg", pcaPlot1, width=6, height=6)
```

Run PERMANOVA. 
```{r}
# scale data
vegan <- scale(counts_pca[c(6:97)])

# PerMANOVA 
permanova<-adonis2(vegan ~ isotope, data = counts_pca, method='eu')
permanova
```

There are clearly differences (p=0.001) between the C31 samples and other samples. Look at differences by treatment within the 12C and 13C. 

Plot by temperature treatment within the 12C isotopes (unlabeled).  
```{r}
counts_pca_12C<-total_counts%>%
  pivot_wider(names_from=compound, values_from=total.ion.count)%>%
  filter(isotope=="12C")

scaled.pca.12C<-prcomp(counts_pca_12C[c(6:97)],scale=TRUE, center=TRUE) 
```

```{r}
pcaPlot2<-ggplot2::autoplot(scaled.pca.12C, data=counts_pca_12C, frame.colour="treatment", loadings=FALSE, colour="treatment", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  theme_classic()+
  scale_colour_manual(values=c("blue", "red"))+
  scale_fill_manual(values=c("blue", "red"))+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot2

ggsave("Mcap2021/Figures/Metabolomics/pca_treatment_12C.jpg", pcaPlot2, width=6, height=6)
```

Run PERMANOVA. 
```{r}
# scale data
vegan <- scale(counts_pca_12C[c(6:97)])

# PerMANOVA 
permanova<-adonis2(vegan ~ treatment, data = counts_pca_12C, method='eu')
permanova
```

There is a difference between temperature treatments in the 12C samples (p=0.015). It doesn't look like much separation in the plot. 

Examine differences by treatment in the 13C samples.  

```{r}
counts_pca_13C<-total_counts%>%
  pivot_wider(names_from=compound, values_from=total.ion.count)%>%
  filter(isotope=="13C")

scaled.pca.13C<-prcomp(counts_pca_13C[c(6:97)],scale=TRUE, center=TRUE) 
```

```{r}
pcaPlot3<-ggplot2::autoplot(scaled.pca.13C, data=counts_pca_13C, frame.colour="treatment",  loadings=FALSE, colour="treatment", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  theme_classic()+
  scale_colour_manual(values=c("blue", "red"))+
  scale_fill_manual(values=c("blue", "red"))+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot3

ggsave("Mcap2021/Figures/Metabolomics/pca_treatment_13C.jpg", pcaPlot3, width=6, height=6)
```

There may be more of a difference here. 

Run PERMANOVA. 
```{r}
# scale data
vegan <- scale(counts_pca_13C[c(6:97)])

# PerMANOVA 
permanova<-adonis2(vegan ~ treatment, data = counts_pca_13C, method='eu')
permanova
```

There is a difference between treatments in the 13C samples (p=0.005). We will investigate these differences more at the individual metabolite level and the labeling patterns. 


QUESTIONS: 
- How to get total metabolite abundance - by summing all "isotopeLabel" types together? Is this the right way of doing this? 
- Is normalizing to sample median the right way to normalize? 
- How do we want to use 12C vs 13C? 



## Clean metabolite names and remove standards  

Clean any names that have (+HAc) and (+), rename to just include the metabolite name.  

```{r, echo=FALSE, results=FALSE}
levels(total_counts$compound)
grep("PosIS", levels(total_counts$compound)) 
grep("NegIS", levels(total_counts$compound)) 
grep("(+HAc)", levels(total_counts$compound)) #3 metabolites with HAc+, need to rename
grep("SIM", levels(total_counts$compound)) 

length(levels(total_counts$compound)) #we have 92 metabolites in our dataset 

total_counts<-total_counts%>%
  mutate(compound = str_remove(compound, pattern=fixed(' (+HAc)')))%>% #rename any with +HAc to remove the +HAc
  mutate(compound = as.factor(compound))

total_counts<- droplevels(total_counts)
length(levels(total_counts$compound))
levels(total_counts$compound) #names are now cleaned
```

Output file to .csv.   

```{r}
total_counts%>%
  write_csv("Mcap2021/Output/Metabolomics/processed_total_ion_counts.csv")
```

# PLS-DA analysis  

Load data if starting from this point in the script.    

```{r}
metabolites <- read.csv("Mcap2021/Output/Metabolomics/processed_total_ion_counts.csv")
```

`log.ion.counts` indicates log transformed median normalized ion counts for each metabolite as a sum of ion counts from C12 parent and C13 labels to generate total metabolite abundance regardless of labeling. 

## Generate PLS-DA for treatment: C13 samples     

Script modified from the following tutorial: https://mixomicsteam.github.io/Bookdown/plsda.html

Plot PLSDA 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X_C13 <- metabolites%>%
  dplyr::select(compound, isotope, treatment, tank, log.ion.counts)%>%
  filter(isotope=="13C")%>%
  spread(compound, log.ion.counts) #generate spread data frame

levels(as.factor(X_C13$treatment))

Y_C13 <- as.factor(X_C13$treatment) #select treatment names
Y_C13

X_C13<-X_C13[4:95] #pull only data columns

# run PLSDA 
MyResult.plsda_C13 <- plsda(X_C13,Y_C13) # 1 Run the method
plotIndiv(MyResult.plsda_C13)    # 2 Plot the samples
plotVar(MyResult.plsda_C13, cutoff = 0.7)    

treatment_cols<-c("blue", "red") 
            
pdf("Mcap2021/Figures/Metabolomics/PLSDA_C13.pdf", width=9, height=6)
plotIndiv(MyResult.plsda_C13, col=treatment_cols, ind.names = FALSE, legend=TRUE, legend.title = "Treatment - C13 Samples", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda_C13, col=treatment_cols, ind.names = FALSE, legend=TRUE, legend.title = "Treatment - C13 Samples", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

### Extract VIP scores from PLS-DA - C13   

View the metabolites that are most highly differentiating metabolites between treatments.     

```{r}
#extract
treatment_VIP <- PLSDA.VIP(MyResult.plsda_C13)
treatment_VIP_df <- as.data.frame(treatment_VIP[["tab"]])
treatment_VIP_df

# Converting row names to column
treatment_VIP_table <- rownames_to_column(treatment_VIP_df, var = "Metabolite")

#filter for VIP > 1
treatment_VIP_1 <- treatment_VIP_table %>% 
  filter(VIP >= 1)

write_csv(treatment_VIP_1, "Mcap2021/Output/Metabolomics/Treatment_C13_VIPs.csv")

#plot
treatment_VIP_1 %>%
    arrange(VIP) %>%
  
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Treatment VIP - C13") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("Mcap2021/Figures/Metabolomics/Treatment_C13_VIP.pdf", width=5, height=8)
treatment_VIP_1 %>%
    arrange(VIP) %>%
  
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(size=3) +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Treatment VIP - C13") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation in treatment in the 13C samples.  

### Plot abundance of the VIP metabolites between treatments - C13

Filter dataframe by desired metabolites and plot presence in each treatment for the C13 samples. 
```{r}
C13_vip_list<-c(treatment_VIP_1$Metabolite)

C13_vip_metabolites<-metabolites%>%
  filter(compound %in% C13_vip_list)%>%
  filter(isotope=="13C")
```

Plot abundance of these metabolites in each sample. 

```{r}
C13_vip_abund_plot<-C13_vip_metabolites%>%
  
  ggplot(aes(x=reorder(compound, -log.ion.counts), y=log.ion.counts, color=treatment, group=treatment))+
  geom_point(position=position_jitterdodge(0.2))+
  geom_boxplot(aes(group=interaction(compound, treatment)),position=position_dodge(0.2))+
  scale_color_manual(values=c("blue", "red"), name="Treatment")+
  ylab("log(normalized ion count)")+
  xlab("VIP Metabolite")+
  ggtitle("VIP Abundance - C13")+
  theme_classic()+
  theme(
    axis.text=element_text(color="black", size=12), 
    axis.text.x=element_text(angle=45, hjust=1), 
    axis.title=element_text(color="black", face="bold", size=12),
    plot.margin=margin(1,1,1,1, "cm"),
    legend.text=element_text(size=12),
    legend.title=element_text(size=12, face="bold")
  )

C13_vip_abund_plot

ggsave("Mcap2021/Figures/Metabolomics/VIP_Abundance_C13.jpg", C13_vip_abund_plot, width=11, height=6)
```

Next plot the difference between ambient and high at the treatment level. Negative indicates high is lower than ambient, positive indicates high is higher than ambient. 

```{r}
C13_vip_diff_plot<-C13_vip_metabolites%>%
  arrange(compound)%>%
  group_by(compound, treatment)%>%
  summarise(mean=mean(log.ion.counts))%>%
  group_by(compound)%>%
  summarise(change=(mean-first(mean))/first(mean))%>% #calculate the difference of high from ambient
  filter(change !=0)%>% #remove zero values (comparing ambient to ambient)
  
  ggplot(aes(x=reorder(compound, -change), y=change, color=factor(ifelse(change>0,"Greater in High","Greater in Ambient")), group=compound))+
  geom_bar(stat="identity",position=position_jitterdodge(0.2), fill="white")+
  scale_color_manual(values=c("blue", "red"), name="Treatment")+
  ylab("Relative abundance")+
  xlab("VIP Metabolite")+
  ggtitle("VIP Difference - C13")+
  theme_classic()+
  theme(
    axis.text=element_text(color="black", size=12), 
    axis.text.x=element_text(angle=45, hjust=1), 
    axis.title=element_text(color="black", face="bold", size=12),
    plot.margin=margin(1,1,1,1, "cm"),
    legend.text=element_text(size=12),
    legend.title=element_text(size=12, face="bold")
  )

C13_vip_diff_plot

ggsave("Mcap2021/Figures/Metabolomics/VIP_Difference_C13.jpg", C13_vip_diff_plot, width=11, height=6)
```

I submitted the VIP list to metaboanalyst to conduct KEGG/class enrichment. These were the significantly enriched pathways in this VIP list: 

KEGG Pathways: 
- Aminoacyl-tRNA biosynthesis (FDR p<0.001)
- Arginine biosynthesis (FDR p<0.001)
- Alanine, aspartate, and glutamate metabolism (FDR p<0.001)
- Valine, leucine, and isoleucine biosynthesis (FDR p=0.004)
- Nicotinate and nicotinamide metabolism (FDR p=0.026)

Class Enrichment: 
- Amino acids and peptides (FDR p<0.001)
- Monosaccharides (FDR p<0.001)
- Cholines (FDR p=0.033)
- Sulfonic acids (FDR p=0.033)
- Short-chain acids and derivatives (FDR p=0.047)


## Generate PLS-DA for treatment: C12 samples     

Plot PLSDA 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X_C12 <- metabolites%>%
  dplyr::select(compound, isotope, treatment, tank, log.ion.counts)%>%
  filter(isotope=="12C")%>%
  spread(compound, log.ion.counts) #generate spread data frame

levels(as.factor(X_C12$treatment))

Y_C12 <- as.factor(X_C12$treatment) #select treatment names
Y_C12

X_C12<-X_C12[4:95] #pull only data columns

# run PLSDA 
MyResult.plsda_C12 <- plsda(X_C12,Y_C12) # 1 Run the method
plotIndiv(MyResult.plsda_C12)    # 2 Plot the samples
plotVar(MyResult.plsda_C12, cutoff = 0.7)    
            
pdf("Mcap2021/Figures/Metabolomics/PLSDA_C12.pdf", width=9, height=6)
plotIndiv(MyResult.plsda_C12, col=treatment_cols, ind.names = FALSE, legend=TRUE, legend.title = "Treatment - C12 Samples", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda_C12, col=treatment_cols, ind.names = FALSE, legend=TRUE, legend.title = "Treatment - C12 Samples", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

### Extract VIP scores from PLS-DA - C13   

View the metabolites that are most highly differentiating metabolites between treatments.     

```{r}
#extract
treatment_VIP_C12 <- PLSDA.VIP(MyResult.plsda_C12)
treatment_VIP_C12_df <- as.data.frame(treatment_VIP_C12[["tab"]])
treatment_VIP_C12_df

# Converting row names to column
treatment_VIP_C12_table <- rownames_to_column(treatment_VIP_C12_df, var = "Metabolite")

#filter for VIP > 1
treatment_VIP_C12_1 <- treatment_VIP_C12_table %>% 
  filter(VIP >= 1)

write_csv(treatment_VIP_C12_1, "Mcap2021/Output/Metabolomics/Treatment_C12_VIPs.csv")

#plot
treatment_VIP_C12_1 %>%
    arrange(VIP) %>%
  
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Treatment VIP - C12") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("Mcap2021/Figures/Metabolomics/Treatment_C12_VIP.pdf", width=5, height=8)
treatment_VIP_1 %>%
    arrange(VIP) %>%
  
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point(size=3) +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Treatment VIP - C12") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation in treatment in the 12C samples.  

The separation and list of metabolites are similar between the two isotope treatments. 

### Plot abundance of the VIP metabolites between treatments - C12

Filter dataframe by desired metabolites and plot presence in each treatment for the C12 samples. 
```{r}
C12_vip_list<-c(treatment_VIP_C12_1$Metabolite)

C12_vip_metabolites<-metabolites%>%
  filter(compound %in% C12_vip_list)%>%
  filter(isotope=="12C")
```

Plot abundance of these metabolites in each sample. 

```{r}
C12_vip_abund_plot<-C12_vip_metabolites%>%
  
  ggplot(aes(x=reorder(compound, -log.ion.counts), y=log.ion.counts, color=treatment, group=treatment))+
  geom_point(position=position_jitterdodge(0.2))+
  geom_boxplot(aes(group=interaction(compound, treatment)),position=position_dodge(0.2))+
  scale_color_manual(values=c("blue", "red"), name="Treatment")+
  ylab("log(normalized ion count)")+
  xlab("VIP Metabolite")+
  ggtitle("VIP Abundance - C12")+
  theme_classic()+
  theme(
    axis.text=element_text(color="black", size=12), 
    axis.text.x=element_text(angle=45, hjust=1), 
    axis.title=element_text(color="black", face="bold", size=12),
    plot.margin=margin(1,1,1,1, "cm"),
    legend.text=element_text(size=12),
    legend.title=element_text(size=12, face="bold")
  )

C12_vip_abund_plot

ggsave("Mcap2021/Figures/Metabolomics/VIP_Abundance_C12.jpg", C12_vip_abund_plot, width=11, height=6)
```

Next plot the difference between ambient and high at the treatment level. Negative indicates high is lower than ambient, positive indicates high is higher than ambient. 

```{r}
C12_vip_diff_plot<-C12_vip_metabolites%>%
  arrange(compound)%>%
  group_by(compound, treatment)%>%
  summarise(mean=mean(log.ion.counts))%>%
  group_by(compound)%>%
  summarise(change=(mean-first(mean))/first(mean))%>% #calculate the difference of high from ambient
  filter(change !=0)%>% #remove zero values (comparing ambient to ambient)
  
  ggplot(aes(x=reorder(compound, -change), y=change, color=factor(ifelse(change>0,"Greater in High","Greater in Ambient")), group=compound))+
  geom_bar(stat="identity",position=position_jitterdodge(0.2), fill="white")+
  scale_color_manual(values=c("blue", "red"), name="Treatment")+
  ylab("Relative abundance")+
  xlab("VIP Metabolite")+
  ggtitle("VIP Difference - C12")+
  theme_classic()+
  theme(
    axis.text=element_text(color="black", size=12), 
    axis.text.x=element_text(angle=45, hjust=1), 
    axis.title=element_text(color="black", face="bold", size=12),
    plot.margin=margin(2,2,2,2, "cm"),
    legend.text=element_text(size=12),
    legend.title=element_text(size=12, face="bold")
  )

C12_vip_diff_plot

ggsave("Mcap2021/Figures/Metabolomics/VIP_Difference_C12.jpg", C12_vip_diff_plot, width=11, height=6)
```

There is some variation in metabolite differences between C12 and C13. We will discuss how we want to use these data. 

I submitted the VIP list to metaboanalyst to conduct KEGG/class enrichment. These were the significantly enriched pathways in this VIP list: 

KEGG Pathways: 
- Aminoacyl-tRNA biosynthesis (FDR p<0.001)
- Arginine biosynthesis (FDR p<0.001)
- Alanine, aspartate, and glutamate metabolism (FDR p=0.003)
- Valine, leucine, and isoleucine biosynthesis (FDR p=0.006)
- Purine metabolism (FDR p=0.017)
*In this set purine metabolism is significant whereas in C13 nicotinamide metabolism is significant. All others are the same.* 

Class Enrichment: 
- Amino acids and peptides (FDR p<0.001)
- Pyrimidines (FDR p<0.001)
- Purines (FDR p<0.001)
- TCA Acids (FDR p<0.001)
*In C13 samples, Pyrimidines, purines, and TCA acids are not enriched, but cholines, sulfonic acids, monosaccharides, and short chain acids are*  

Overall, nitrogen and amino acid/peptide metabolism are driving differences between high and ambient treatments. 
