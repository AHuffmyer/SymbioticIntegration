---
title: Montipora capitata 2021 thermal stress metabolomics analysis 
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

This script analyzes stable isotope metabolomic data for the *Montipora capitata* 2021 larval thermal stress experiment.  

# Set Up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("factoextra" %in% rownames(installed.packages()) == 'FALSE') install.packages('factoextra') 
if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify') 
if ("naniar" %in% rownames(installed.packages()) == 'FALSE') install.packages('naniar') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics") 
if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire') 
if ("VennDiagram" %in% rownames(installed.packages()) == 'FALSE') install.packages('VennDiagram') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 
if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4') 
if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest') 
if ("readxl" %in% rownames(installed.packages()) == 'FALSE') install.packages('readxl') 
if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
if ("multcomp" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcomp') 
if ("data.table" %in% rownames(installed.packages()) == 'FALSE') install.packages('data.table') 

#load packages
library("ggplot2")
library('vegan')
library('factoextra')
library('ggfortify')
library('naniar')
library('cowplot')
library("mixOmics")
library("tidyverse")
library("RVAideMemoire")
library("VennDiagram")
library("broom")
library("lme4")
library("lmerTest")
library("readxl")
library("emmeans")
library("multcomp")
library("data.table")
```

# Load Data 

Load data. 
```{r}
#load pool size quantified as total intensity for each metabolite, this dataset will require median normalization
pool_size<-read_xlsx("Mcap2021/Data/Metabolomics/metabolite_data.xlsx", sheet="Pool Size")

#load per atom basis for labeling proportions, this dataset is proportion data, so no normalization is necessary
enrichment<-read_xlsx("Mcap2021/Data/Metabolomics/metabolite_data.xlsx", sheet="Enrichment")

#load proportion labeling by Number Carbons Labeled, this dataset is proportion data, so no normalization is necessary
fractions<-read_xlsx("Mcap2021/Data/Metabolomics/metabolite_data.xlsx", sheet="Fractions")
```

# Is metabolite pool size different between isotope treatments? (Methodological control 1) 

## PCA analysis 

### Prepare data 

First, view metabolite pool size profiles between isotope treatments using a PCA analysis. 

```{r}
str(pool_size)
```

Normalize pool size to the sample median to account for any variation in the number of larvae across samples. 
```{r}
pool_size <- pool_size %>%
  mutate(across(`12C_Ambient-A1_I7`:`Dark-13C_High-Pool_I40`, ~ .x / median(.x, na.rm = TRUE))) #normalize the intensity values to the columns median to account for any variation in larval number in each sample 
```

```{r}
pool_size<-pool_size%>%
  select(!starts_with("Blank"))
```

Mutate the data to be in long rather than wide format and keep only relevant columns.  

```{r}
pool_size <- pool_size %>% 
  pivot_longer(names_to = "sample", values_to="intensity.norm", `12C_Ambient-A1_I7`:`Dark-13C_High-Pool_I40`)%>%
  select(c(Compound, sample, intensity.norm))
```

Add metadata column with isotope, treatment, tank, and tube ID. 
```{r}
pool_size<-pool_size%>%
  separate(sample, c("isotope", "treatment","tube"), sep="_", remove = FALSE)%>%
  separate(treatment, c("treatment", "tank"))

#convert to factors 
pool_size$isotope<-as.factor(pool_size$isotope)
pool_size$treatment<-as.factor(pool_size$treatment)
pool_size$tank<-as.factor(pool_size$tank)
pool_size$tube<-as.factor(pool_size$tube)
pool_size$Compound<-as.factor(pool_size$Compound)
```

Check distribution of data.  
```{r}
hist(pool_size$intensity.norm)
hist(log(1+pool_size$intensity.norm))
```

Since distribution is very skewed, add log normalized column. 
```{r}
pool_size$log.intensity.norm<-log(1+pool_size$intensity.norm)
```

Clean metabolite names and remove standards.  

Clean any names that have (+HAc), rename to just include the metabolite name.  

```{r, echo=FALSE, results=FALSE}
levels(pool_size$Compound)
grep("PosIS", levels(pool_size$Compound)) 
grep("NegIS", levels(pool_size$Compound)) 
grep("(+HAc)", levels(pool_size$Compound)) #3 metabolites with HAc+, need to rename
grep("SIM", levels(pool_size$Compound)) 

length(levels(pool_size$Compound)) #we have 90 metabolites in our dataset 

pool_size<-pool_size%>%
  mutate(Compound = str_remove(Compound, pattern=fixed(' (+HAc)')))%>% #rename any with +HAc to remove the +HAc
  mutate(Compound = as.factor(Compound))

pool_size<- droplevels(pool_size)
length(levels(pool_size$Compound))
levels(pool_size$Compound) #names are now cleaned
```

### Plot pool size  

Plot pool size in descending order by isotope treatment. 

```{r}
#make summary table
data_plotting<-plyr::ddply(pool_size, c("isotope", "Compound", "treatment"), summarise,
                N    = length(log.intensity.norm[!is.na(log.intensity.norm)]),
                mean = mean(log.intensity.norm, na.rm=TRUE),
                sd   = sd(log.intensity.norm, na.rm=TRUE),
                se   = sd / sqrt(N)
)

data_plotting<-data_plotting%>%arrange(Compound)
```

Montiporic acids are highly abundant and will mask other values in the plot. First plot only for Montiporic acids and then plot by other metabolites. 
```{r}
metab_compounds_isotopes_acids<-data_plotting%>%
  filter(str_detect(Compound, "^Montiporic"))%>%
  filter(!isotope=="Dark-13C")%>%
         
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=isotope, group=isotope)) + 
  facet_wrap(~treatment, nrow=2)+
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=isotope), width=0, position=position_dodge(0.9))+
  scale_fill_manual(values=c("gray", "lightgreen"))+
  theme_classic()+
  xlab("Metabolites")+
  ylab("log(Normalized Pool Size)")+
  theme(
    legend.position="none", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds_isotopes_acids
```
It is interesting that there was higher production of Montiporic acids in the dark. 

Plot remaining metabolites. 
```{r}
metab_compounds_isotopes<-data_plotting%>%
  filter(!str_detect(Compound, "^Montiporic"))%>%
  filter(!isotope=="Dark-13C")%>%
  
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=isotope, group=isotope)) + 
  facet_wrap(~treatment, nrow=2)+
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=isotope), width=0, position=position_dodge(0.9))+
  theme_classic()+
  xlab("Metabolites")+
  ylab("log(Normalized Pool Size)")+
  scale_fill_manual(values=c("gray", "lightgreen"))+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds_isotopes
```
There is variability by isotope treatment, but there are no clear metabolites that drop out between isotope treatments, this is the main thing we would be looking for.  

Save plots. 
```{r}
poolsize_fig<-plot_grid(metab_compounds_isotopes_acids, metab_compounds_isotopes, nrow = 1, align = 'h', labels = c('A', 'B'), rel_widths=c(0.2, 1))

ggsave("Mcap2021/Figures/Metabolomics/Controls/pool_size_compounds.jpg", plot=poolsize_fig, width=26, height=10)
```

Plot by temperature. 

```{r}
metab_compounds_temperature_acids<-data_plotting%>%
  filter(str_detect(Compound, "^Montiporic"))%>%
  filter(!isotope=="Dark-13C")%>%
         
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=treatment, group=treatment)) + 
  facet_wrap(~isotope, nrow=3)+
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=treatment), width=0, position=position_dodge(0.9))+
  scale_fill_manual(values=c("blue", "red"))+
  theme_classic()+
  xlab("Metabolites")+
  ylab("log(Normalized Pool Size)")+
  theme(
    legend.position="none", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds_temperature_acids
```
It is interesting that there was higher production of Montiporic acids in the dark. 

Plot remaining metabolites. 
```{r}
metab_compounds_temperature<-data_plotting%>%
  filter(!str_detect(Compound, "^Montiporic"))%>%
  filter(!isotope=="Dark-13C")%>%
  
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=treatment, group=treatment)) + 
  facet_wrap(~isotope, nrow=3)+
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=treatment), width=0, position=position_dodge(0.9))+
  theme_classic()+
  xlab("Metabolites")+
  ylab("log(Normalized Pool Size)")+
  scale_fill_manual(values=c("blue", "red"))+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds_temperature
```

Save plots. 
```{r}
poolsize_temp_fig<-plot_grid(metab_compounds_temperature_acids, metab_compounds_temperature, nrow = 1, align = 'h', labels = c('A', 'B'), rel_widths=c(0.2, 1))

ggsave("Mcap2021/Figures/Metabolomics/Controls/pool_size_compounds_temperature.jpg", plot=poolsize_temp_fig, width=26, height=10)
```

### Run PCA for C12 vs C13 light samples

Convert data to wide format.

```{r}
pool_size_pca<-pool_size%>%
  select(!intensity.norm)%>%
  pivot_wider(names_from=Compound, values_from=log.intensity.norm)%>%
  filter(!isotope=="Dark-13C")
```

Generate a scaled data frame. 

```{r}
pool_size_pca_ambient<-pool_size_pca%>%
  filter(treatment=="Ambient")

scaled.pca.ambient<-prcomp(pool_size_pca_ambient[c(6:95)],scale=TRUE, center=TRUE) 

pool_size_pca_high<-pool_size_pca%>%
  filter(treatment=="High")

scaled.pca.high<-prcomp(pool_size_pca_high[c(6:95)],scale=TRUE, center=TRUE) 
```

Plot PCA by isotope treatment for each temperature. 
```{r}
#ambient
pcaPlot1<-ggplot2::autoplot(scaled.pca.ambient, data=pool_size_pca_ambient, frame.colour="isotope", loadings=FALSE, colour="isotope", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  facet_wrap(~treatment)+
  theme_classic()+
  scale_colour_manual(values=c("gray", "lightgreen"))+
  scale_fill_manual(values=c("gray", "lightgreen"))+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot1

#high
pcaPlot2<-ggplot2::autoplot(scaled.pca.high, data=pool_size_pca_high, frame.colour="isotope", loadings=FALSE, colour="isotope", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  facet_wrap(~treatment)+
  theme_classic()+
  scale_colour_manual(values=c("gray", "lightgreen"))+
  scale_fill_manual(values=c("gray", "lightgreen"))+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot2

pca_isotope_grid<-plot_grid(pcaPlot1, pcaPlot2, nrow=2, ncol=1)

ggsave("Mcap2021/Figures/Metabolomics/Controls/pca_isotope.jpg", pca_isotope_grid, width=5, height=8)
```

Run PERMANOVA to test difference between C12 and C13 isotopes metabolite pool sizes. 
```{r}
# scale data
pool_size_pca_12Cvs13C<-pool_size_pca%>%
  filter(!isotope=="Dark-13C")

vegan <- scale(pool_size_pca_12Cvs13C[c(6:95)])

# PerMANOVA 
permanova<-adonis2(vegan ~ isotope*treatment, data = pool_size_pca_12Cvs13C, method='eu')
permanova
```
                  Df SumOfSqs      R2      F Pr(>F)    
isotope            1   245.91 0.11880 3.4681  0.001 ***
treatment          1   326.29 0.15763 4.6018  0.001 ***
isotope:treatment  1    79.70 0.03850 1.1240  0.331    
Residual          20  1418.10 0.68507                  
Total             23  2070.00 1.00000  

There is significant variation in the PCA by isotope but response to temperature is not affected by isotope, indicated by non-significant interaction term. 

Plot metabolites of interest to investigate the differences in isotope treatments.

```{r}
#make summary table
pool_size_plotting<-plyr::ddply(pool_size, c("Compound", "isotope"), summarise,
                N    = length(log.intensity.norm[!is.na(log.intensity.norm)]),
                mean = mean(log.intensity.norm, na.rm=TRUE),
                sd   = sd(log.intensity.norm, na.rm=TRUE),
                se   = sd / sqrt(N)
)

pool_size_plotting<-pool_size_plotting%>%arrange(Compound)%>%filter(!isotope=="Dark-13C")
```

```{r}
pool_photo_metabolites<-pool_size_plotting%>%
  filter(Compound %in% c("Glucose", "Fructose-6-phosphate", "Glucose-6-phosphate", "Pyruvate", "Dihydroxyacetone phosphate", "3-Phosphoglycerate", "Lactate", "Ribose phosphate", "Xylose-5-phosphate", "Citrate", "Isocitrate", "a-ketoglutarate", "Succinate", "Malate"))%>%
         
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=isotope, group=isotope)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=isotope), width=0, position=position_dodge(0.9))+
  theme_classic()+
  scale_fill_manual(values=c("gray", "lightgreen"))+
  xlab("")+
  ylab("Pool Size")+
  ggtitle("Carbon metabolism")+
  geom_text(x=2, y=3.5, label="**", color="black", size=5)+
  geom_text(x=5, y=3.5, label="**", color="black", size=5)+
  geom_text(x=6, y=2, label="**", color="black", size=5)+
  ylim(0,4)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=45, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );pool_photo_metabolites

ggsave("Mcap2021/Figures/Metabolomics/Controls/poolsize_isotope_carbon.jpg", plot=pool_photo_metabolites, width=8, height=5)
```

```{r}
pool_ammonia_metabolites<-pool_size_plotting%>%
  filter(Compound %in% c("Glutamate", "Glutamine", "a-ketoglutarate", "N-acetyl-glutamate", "Carbamoyl phosphate", "Citrulline", "Aspartate",  "Arginine", "Ornithine", "Arginine-Glutamine", "L-arginino-succinate"))%>%
         
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=isotope, group=isotope)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=isotope), width=0, position=position_dodge(0.9))+
  theme_classic()+
  scale_fill_manual(values=c("gray", "lightgreen"))+
  xlab("")+
  ylab("Pool Size")+
  ggtitle("Nitrogen metabolism")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=45, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );pool_ammonia_metabolites

ggsave("Mcap2021/Figures/Metabolomics/Controls/poolsize_isotope_nitrogen.jpg", plot=pool_ammonia_metabolites, width=7, height=5)
```

Plot a stress metabolite - methionine sulfoxide. 
```{r}
pool_host_metabolites<-pool_size_plotting%>%
  filter(Compound %in% c("Methionine sulfoxide"))%>%
         
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=isotope, group=isotope)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=isotope), width=0, position=position_dodge(0.9))+
  theme_classic()+
  scale_fill_manual(values=c("gray", "lightgreen"))+
  scale_x_discrete(labels=c("Methionine \nSulfoxide"))+
  xlab("")+
  ylab("Pool Size")+
  ylim(0,1.5)+
  geom_text(x=1, y=1.3, label="**", color="black", size=8)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=45, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );pool_host_metabolites

ggsave("Mcap2021/Figures/Metabolomics/Controls/poolsize_isotope_methioninesulfoxide.jpg", plot=pool_host_metabolites, width=5, height=5)
```

### Conduct ANOVA testing of metabolites of interest 

Set list of metabolites of interest for testing. 
```{r}
control_list<-c("Methionine sulfoxide","Glutamate", "Glutamine", "a-ketoglutarate", "N-acetyl-glutamate", "Carbamoyl phosphate", "Citrulline", "Aspartate", "L-arginino-succinate", "Arginine", "Ornithine", "Arginine-Glutamine", "Glucose", "Fructose-6-phosphate", "Glucose-6-phosphate", "Pyruvate", "Dihydroxyacetone phosphate", "3-Phosphoglycerate", "Lactate", "Ribose phosphate", "Xylose-5-phosphate", "Citrate", "Isocitrate", "a-ketoglutarate", "Succinate", "Malate")
```

Calculate difference in labeling between isotope for these key metabolites. 
```{r}
#show for each compound 
pool_size%>%
  group_by(Compound, isotope)%>%
  summarise(mean = mean(log.intensity.norm, na.rm=TRUE))%>%
  arrange(Compound)%>%
  filter(Compound %in% control_list)%>%
  group_by(Compound)%>%
  pivot_wider(names_from=isotope, values_from=mean)%>%
  mutate(perc_diff_12vs13=((`13C`-`12C`)/`12C`)*100)
```

Calculate average pool size for metabolites of interest and then all metabolites by isotope. 
```{r}
pool_size%>%
  filter(Compound %in% control_list)%>%
  filter(!isotope=="Dark-13C")%>%
  group_by(isotope, Compound)%>%
  summarise(mean = mean(log.intensity.norm, na.rm=TRUE), se=sd(log.intensity.norm, na.rm=TRUE)/sqrt(length(log.intensity.norm)))

#test difference in label by isotope for targets 
test<-pool_size%>%
  filter(Compound %in% control_list)%>%
  filter(!isotope=="Dark-13C")%>%
  aov(log.intensity.norm~isotope*Compound, data=.)

summary(test)
emm<-emmeans(test, ~isotope | Compound)
pairs(emm)

```

Isocitrate (P<0.001), citrate (P=0.001), succinate (P=0.004), and methionine sulfoxide (P<0.001) were different between C13 and C12. 

Show mean percent difference for each of these metabolites. 
```{r}
#show overall mean for target metabolites
pool_size%>%
  group_by(Compound, isotope)%>%
  filter(!isotope=="Dark-13C")%>%
  summarise(mean = mean(log.intensity.norm, na.rm=TRUE))%>%
  arrange(Compound)%>%
  filter(Compound %in% c("Citrate", "Isocitrate", "Succinate", "Methionine sulfoxide"))%>%
  group_by(Compound)%>%
  pivot_wider(names_from=isotope, values_from=mean)%>%
  mutate(perc_change_12vs13=((`13C`-`12C`)/`13C`)*100)
```
Citrate (28% higher), Isocitrate (32% higher), Methionine Sulfoxide (70% higher) are higher in C13, Succinate is lower in C13 (15% lower). 

# Is metabolite pool size different between temperature treatments? 

## PCA Analysis 

### C12 - high vs ambient 

From the PCA objects made in the previous section, now look at temperature differences within isotope treatment.  

Plot by temperature treatment within the 12C isotopes (unlabeled).  
```{r}
pool_size_pca_12C<-pool_size%>%
  select(!intensity.norm)%>%
  pivot_wider(names_from=Compound, values_from=log.intensity.norm)%>%
  filter(isotope=="12C")

scaled.pca.12C<-prcomp(pool_size_pca_12C[c(6:95)],scale=TRUE, center=TRUE) 
```

```{r}
pcaPlot2<-ggplot2::autoplot(scaled.pca.12C, data=pool_size_pca_12C, frame.colour="treatment", loadings=FALSE, colour="treatment", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  theme_classic()+
  scale_colour_manual(values=c("blue", "red"))+
  scale_fill_manual(values=c("blue", "red"))+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot2

ggsave("Mcap2021/Figures/Metabolomics/pca_treatment_12C.jpg", pcaPlot2, width=6, height=6)
```

Run PERMANOVA. 
```{r}
# scale data
vegan <- scale(pool_size_pca_12C[c(6:95)])

# PerMANOVA 
permanova<-adonis2(vegan ~ treatment, data = pool_size_pca_12C, method='eu')
permanova
```

adonis2(formula = vegan ~ treatment, data = pool_size_pca_12C, method = "eu")
          Df SumOfSqs      R2      F Pr(>F)  
treatment  1   202.88 0.20493 2.5775  0.025 *
Residual  10   787.12 0.79507                
Total     11   990.00 1.00000 

There is a difference between temperature treatments in the 12C samples (p=0.025). 

### C13 - high vs ambient 

Examine differences by treatment in the 13C samples.  

```{r}
pool_size_pca_13C<-pool_size%>%
  select(!intensity.norm)%>%
  pivot_wider(names_from=Compound, values_from=log.intensity.norm)%>%
  filter(isotope=="13C")

scaled.pca.13C<-prcomp(pool_size_pca_13C[c(6:95)],scale=TRUE, center=TRUE) 
```

```{r}
pcaPlot3<-ggplot2::autoplot(scaled.pca.13C, data=pool_size_pca_13C, frame.colour="treatment",  loadings=FALSE, colour="treatment", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  theme_classic()+
  scale_colour_manual(values=c("blue", "red"))+
  scale_fill_manual(values=c("blue", "red"))+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot3

ggsave("Mcap2021/Figures/Metabolomics/pca_treatment_13C.jpg", pcaPlot3, width=6, height=6)
```

Run PERMANOVA. 
```{r}
# scale data
vegan <- scale(pool_size_pca_13C[c(6:95)])

# PerMANOVA 
permanova<-adonis2(vegan ~ treatment, data = pool_size_pca_13C, method='eu')
permanova
```

adonis2(formula = vegan ~ treatment, data = pool_size_pca_13C, method = "eu")
          Df SumOfSqs      R2      F Pr(>F)   
treatment  1   220.51 0.22273 2.8656  0.005 **
Residual  10   769.49 0.77727                 
Total     11   990.00 1.00000 

There is a difference between treatments in the 13C samples (p=0.005). 

## PLSDA and VIP analysis 

### Differences by temperature in C13 samples 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X_C13 <- pool_size%>%
  dplyr::select(Compound, isotope, treatment, tank, log.intensity.norm)%>%
  filter(isotope=="13C")%>%
  spread(Compound, log.intensity.norm) #generate spread data frame

levels(as.factor(X_C13$treatment))

Y_C13 <- as.factor(X_C13$treatment) #select treatment names
Y_C13

X_C13<-X_C13[4:93] #pull only data columns

# run PLSDA 
MyResult.plsda_C13 <- plsda(X_C13,Y_C13) # 1 Run the method
plotIndiv(MyResult.plsda_C13)    # 2 Plot the samples
plotVar(MyResult.plsda_C13, cutoff = 0.7)    

treatment_cols<-c("blue", "red") 
            
pdf("Mcap2021/Figures/Metabolomics/PLSDA_C13.pdf", width=9, height=6)
plotIndiv(MyResult.plsda_C13, col=treatment_cols, ind.names = FALSE, legend=TRUE, legend.title = "Treatment - C13 Samples", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 
```

View the VIP metabolites that are most highly differentiating metabolites between treatments.     

```{r}
#extract
treatment_VIP <- PLSDA.VIP(MyResult.plsda_C13)
treatment_VIP_df <- as.data.frame(treatment_VIP[["tab"]])
treatment_VIP_df

# Converting row names to column
treatment_VIP_table <- rownames_to_column(treatment_VIP_df, var = "Metabolite")

#filter for VIP > 1
treatment_VIP_1 <- treatment_VIP_table %>% 
  filter(VIP >= 1)

#plot
VIP_list_plot_C13<-treatment_VIP_1 %>%
            arrange(VIP) %>%
  
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Pool Size VIP - C13") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"));VIP_list_plot_C13

ggsave("Mcap2021/Figures/Metabolomics/VIP_List_C13.jpg", VIP_list_plot_C13, width=4, height=6)

#save VIP values 
treatment_VIP_table %>%
  arrange(VIP) %>%
  write_csv(file="Mcap2021/Output/Metabolomics/VIP_values_poolsize.csv")
```

These lists represent VIPs that drive separation in treatment in the 13C samples.  

#### Plot abundance of the VIP metabolites between treatments - C13

Filter dataframe by desired metabolites and plot presence in each treatment for the C13 samples. 
```{r}
C13_vip_list<-c(treatment_VIP_1$Metabolite)

C13_vip_metabolites<-pool_size%>%
  filter(Compound %in% C13_vip_list)%>%
  filter(isotope=="13C")
```

Plot abundance of these metabolites in each sample. 

```{r}
C13_vip_abund_plot<-C13_vip_metabolites%>%
  
  ggplot(aes(x=reorder(Compound, -log.intensity.norm), y=log.intensity.norm, color=treatment, group=treatment))+
  geom_boxplot(aes(group=interaction(Compound, treatment)),position=position_dodge(0.9))+
  geom_point(position=position_jitterdodge(0.2))+
  scale_color_manual(values=c("blue", "red"), name="Treatment")+
  ylab("log(Normalized Pool Size)")+
  xlab("VIP Metabolite")+
  ggtitle("VIP Abundance - C13")+
  theme_classic()+
  theme(
    axis.text=element_text(color="black", size=12), 
    axis.text.x=element_text(angle=45, hjust=1), 
    axis.title=element_text(color="black", face="bold", size=12),
    plot.margin=margin(1,1,1,1, "cm"),
    legend.text=element_text(size=12),
    legend.title=element_text(size=12, face="bold")
  );C13_vip_abund_plot

ggsave("Mcap2021/Figures/Metabolomics/VIP_Abundance_C13.jpg", C13_vip_abund_plot, width=11, height=6)
```

View a table with mean and SE pool size values for these metabolites at each temperature. 

```{r}
C13_vip_metabolites_sum<-C13_vip_metabolites%>%
  group_by(Compound, treatment)%>%
  select(Compound, treatment, log.intensity.norm)%>%
  summarise(mean=mean(log.intensity.norm, na.rm=TRUE), se=sd(log.intensity.norm, na.rm=TRUE)/sqrt(length(log.intensity.norm)))%>%
  pivot_longer(cols=mean:se, values_to="value")%>%
  mutate(metric=paste(treatment, "_", name))%>%
  select(Compound, value, metric)%>%
  pivot_wider(names_from=metric, values_from=value)

write.csv(C13_vip_metabolites_sum, file="Mcap2021/Output/Metabolomics/VIP_PoolSize_Means.csv")
```

Run an ANOVA for the effect of temperature and metabolite on pool size. 
```{r}
model<-pool_size%>%
  filter(isotope=="13C")%>%
  
  aov(log.intensity.norm ~ treatment * Compound, data=.)

summary(model)

emm<-emmeans(model, ~ treatment|Compound)
pairs(emm)

```

Next plot the fold change ((high - ambient)/ambient) between ambient and high at the treatment level. Negative indicates high is lower than ambient, positive indicates high is higher than ambient. 

```{r}
C13_vip_diff_plot<-C13_vip_metabolites%>%
  arrange(Compound)%>%
  group_by(Compound, treatment)%>%
  summarise(mean_intensity=mean(log.intensity.norm))%>%
  reframe(fold_change=(mean_intensity-first(mean_intensity))/first(mean_intensity))%>% #calculate the difference of high from ambient
  filter(fold_change !=0)%>% #remove zero values (comparing ambient to ambient)

  ggplot(aes(x=reorder(Compound, -fold_change), y=fold_change, color=factor(ifelse(fold_change>0,"Greater in High","Greater in Ambient")), group=Compound))+
  geom_bar(stat="identity",position=position_jitterdodge(0.2), fill="white")+
  scale_color_manual(values=c("blue", "red"), name="Treatment")+
  ylab("Pool Size Fold Change")+
  xlab("VIP Metabolite")+
  ggtitle("VIP Difference - C13")+
  theme_classic()+
  ylim(-1,2)+
  theme(
    axis.text=element_text(color="black", size=12), 
    axis.text.x=element_text(angle=45, hjust=1), 
    axis.title=element_text(color="black", face="bold", size=12),
    plot.margin=margin(1,1,1,1, "cm"),
    legend.text=element_text(size=12),
    legend.title=element_text(size=12, face="bold")
  );C13_vip_diff_plot

ggsave("Mcap2021/Figures/Metabolomics/VIP_Difference_C13.jpg", C13_vip_diff_plot, width=13, height=6)
ggsave("Mcap2021/Figures/Metabolomics/VIP_Difference_C13.pdf", C13_vip_diff_plot, width=13, height=6)

#view mean values for each metabolite
C13_vip_diff_sum<-C13_vip_metabolites%>%
  arrange(Compound)%>%
  group_by(Compound, treatment)%>%
  summarise(mean_intensity=mean(log.intensity.norm))%>%
  reframe(fold_change=(mean_intensity-first(mean_intensity))/first(mean_intensity))%>% #calculate the difference of high from ambient
  filter(fold_change !=0)

write.csv(C13_vip_diff_sum, file="Mcap2021/Output/Metabolomics/VIP_PoolSize_RelDiff.csv")
```

#### *Metabolites that are higher at high temperature:*   
```{r}
C13_vip_metabolites%>%
  arrange(Compound)%>%
  group_by(Compound, treatment)%>%
  summarise(mean=mean(log.intensity.norm))%>%
  group_by(Compound)%>%
  reframe(fold_change=(mean-first(mean))/first(mean))%>% #calculate the difference of high from ambient
  filter(fold_change !=0)%>%
  filter(fold_change>0)%>%
  select(Compound)
```

Aconitate          
Adenosine          
ADP-D-Glucose      
Arginine-Glutamine 
Asparagine         
Aspartate          
Carbamoyl phosphate
Glucose            
Glutamate          
Glycerate          
Homoarginine       
Inositol           
Montiporic Acid A  
Montiporic Acid C  
NAD+               
NADP+              
Phosphocholine     
Proline            
UMP    

#### *Metabolites that are higher at ambient temperature:*   

```{r}
C13_vip_metabolites%>%
  arrange(Compound)%>%
  group_by(Compound, treatment)%>%
  summarise(mean=mean(log.intensity.norm))%>%
  group_by(Compound)%>%
  reframe(fold_change=(mean-first(mean))/first(mean))%>% #calculate the difference of high from ambient
  filter(fold_change !=0)%>%
  filter(fold_change<0)%>%
  select(Compound)
```

Alanine           
Citrulline        
Isoleucine        
Leucine           
Lysine            
N-acetyl-glutamate
N-Acetylaspartate 
N-Acetylputrescine
Ribose phosphate  
Taurine           
Theanine          
Thymine           
Valine            
Xylose-5-phosphate

### Plot C13 abundance for each metabolite  

```{r}
compound_list<-pool_size%>%
  filter(isotope=="13C")%>%
  select(Compound)

compound_list<-c(levels(as.factor(compound_list$Compound)))  

pool_size_plotting<-plyr::ddply(pool_size, c("treatment", "Compound", "isotope"), summarise,
                N    = length(log.intensity.norm[!is.na(log.intensity.norm)]),
                mean = mean(log.intensity.norm, na.rm=TRUE),
                sd   = sd(log.intensity.norm, na.rm=TRUE),
                se   = sd / sqrt(N)
)

pool_size_plotting<-pool_size_plotting%>%
  filter(isotope=="13C")
  
# loop through each compound in the list and create a plot
for (compound in compound_list) {
  
  # subset the fractions dataset for the current compound
  compound_data <- subset(pool_size_plotting, Compound == compound)
  
  abundance.plot <-  ggplot(compound_data, aes(x = treatment, y = mean)) + 
    geom_bar(stat="identity", aes(color=treatment, group=treatment), fill="white", position=position_dodge(), linewidth=1) + 
    scale_color_manual(name="Temperature",values=c("blue", "red"))+
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=treatment), position=position_dodge(0.9), width=0.0, linewidth=1)+
    theme_classic()+
    ggtitle(compound)+
    ylab("Pool Size (log intensity)")+
    xlab("Treatment")+
    theme(
      axis.text=element_text(color="black", size=12), 
      axis.title=element_text(color="black", size=14, face="bold"), 
      legend.text=element_text(color="black", size=12), 
      legend.title=element_text(color="black", size=14, face="bold"), 
      legend.position="none"
    )
  
ggsave(filename=paste0("Mcap2021/Figures/Metabolomics/abundance_plots/", compound, ".jpeg"), plot=abundance.plot, width=4, height=4, units="in")

}
```

Plot glucose individually. 
```{r}
  glucose.pool.plot <- pool_size_plotting%>%
    filter(Compound=="Glucose")%>%
    
    ggplot(aes(x = treatment, y = mean)) + 
    geom_bar(stat="identity", aes(color=treatment, group=treatment), fill="white", position=position_dodge(), linewidth=1) + 
    scale_color_manual(name="Temperature",values=c("blue", "red"))+
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=treatment), position=position_dodge(0.9), width=0.0, linewidth=1)+
    theme_classic()+
    ylab("Pool Size")+
  
    geom_text(label="VIP=1.22", x=1.5, y=4, size=8)+ 
  
    xlab("")+
    ylim(0, 5)+
    theme(
      axis.text=element_text(color="black", size=12), 
      axis.title=element_text(color="black", size=14, face="bold"), 
      legend.text=element_text(color="black", size=12), 
      legend.title=element_text(color="black", size=14, face="bold"), 
      legend.position="none"
    );glucose.pool.plot

ggsave(filename=paste0("Mcap2021/Figures/Metabolomics/glucose_pool_size.jpeg"), plot=glucose.pool.plot, width=2, height=4, units="in")

#view meanas
 glucose.pool.mean <- pool_size_plotting%>%
    filter(Compound=="Glucose");glucose.pool.mean
```

Conduct ANOVA test to look at differences in glucose pools between temperature treatments. 
```{r}
glucose_pool_model<-pool_size%>%
  filter(isotope=="13C")%>%
  
  aov(log.intensity.norm~Compound*treatment, data=.)

emm<-emmeans(glucose_pool_model, ~treatment|Compound)
pairs(emm)


```

# Is metabolite atom enrichment different between temperature treatments? 

We will next look at enrichment data to determine whether metabolites are differentially labeled at high temperature on a per atom basis. Enrichment is the probability of finding a labeled atom at any single site, expressed as a percentage. 

## PCA analysis 

### Prepare data 

First, view metabolite enrichment profiles in the C13 samples using a PCA analysis and plot enrichment levels for each metabolite between treatments.   

```{r}
str(enrichment)
```

```{r}
enrichment<-enrichment%>%
  select(!starts_with("Blank"))
```

Mutate the data to be in long rather than wide format and keep only relevant columns.  

```{r}
enrichment <- enrichment %>% 
  pivot_longer(names_to = "sample", values_to="enrichment", `12C_Ambient-A1_I7`:`Dark-13C_High-Pool_I40`)%>%
  select(c(Compound, sample, enrichment))
```

Add metadata column with isotope, treatment, tank, and tube ID. 
```{r}
enrichment<-enrichment%>%
  separate(sample, c("isotope", "treatment","tube"), sep="_", remove = FALSE)%>%
  separate(treatment, c("treatment", "tank"))

#convert to factors 
enrichment$isotope<-as.factor(enrichment$isotope)
enrichment$treatment<-as.factor(enrichment$treatment)
enrichment$tank<-as.factor(enrichment$tank)
enrichment$tube<-as.factor(enrichment$tube)
enrichment$Compound<-as.factor(enrichment$Compound)
```

Check distribution of data.  
```{r}
hist(enrichment$enrichment)
hist(log(1+enrichment$enrichment))
```

The distribution is skewed, due to the presence of C12 samples that do not incorporate labeling. 
```{r}
enrichment%>%
  group_by(isotope)%>%
  summarise(mean=mean(enrichment, na.rm=TRUE))
```

Labeling is highest in the C13 samples as expected. 

Clean metabolite names and remove standards.  

Clean any names that have (+HAc), rename to just include the metabolite name.  

```{r, echo=FALSE, results=FALSE}
levels(enrichment$Compound)
grep("PosIS", levels(enrichment$Compound)) 
grep("NegIS", levels(enrichment$Compound)) 
grep("(+HAc)", levels(enrichment$Compound)) #3 metabolites with HAc+, need to rename
grep("SIM", levels(enrichment$Compound)) 

length(levels(enrichment$Compound)) #we have 90 metabolites in our dataset 

enrichment<-enrichment%>%
  mutate(Compound = str_remove(Compound, pattern=fixed(' (+HAc)')))%>% #rename any with +HAc to remove the +HAc
  mutate(Compound = as.factor(Compound))

enrichment<-droplevels(enrichment)
length(levels(enrichment$Compound))
levels(enrichment$Compound) #names are now cleaned
```

### Plot enrichment level for each metabolite     

Plot enrichment in descending order by temperature treatment. 

```{r}
#make summary table
enrichment_plotting<-plyr::ddply(enrichment, c("treatment", "Compound", "isotope"), summarise,
                N    = length(enrichment[!is.na(enrichment)]),
                mean = mean(enrichment, na.rm=TRUE),
                sd   = sd(enrichment, na.rm=TRUE),
                se   = sd / sqrt(N)
)

enrichment_plotting<-enrichment_plotting%>%arrange(Compound)%>%filter(isotope=="13C")
```

Plot enrichment for each metabolite. 
```{r}
enrichment_all_metabolites<-enrichment_plotting%>%
         
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=treatment, group=treatment)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=treatment), width=0, position=position_dodge(0.9))+
  theme_classic()+
  scale_fill_manual(values=c("blue", "red"))+
  xlab("Metabolites")+
  ylab("Enrichment")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );enrichment_all_metabolites

ggsave("Mcap2021/Figures/Metabolomics/enrichment_all_compounds.jpg", plot=enrichment_all_metabolites, width=26, height=6)
```

There may be difference in per atom labeling in some metabolites. 

### Plot PCA and run PERMANOVA 

Examine differences by treatment in the 13C samples.  

```{r}
enrichment_pca_13C<-enrichment%>%
  pivot_wider(names_from=Compound, values_from=enrichment)%>%
  filter(isotope=="13C")

#replace na with 0 
enrichment_pca_13C[is.na(enrichment_pca_13C)] <- 0

#remove any metabolite that is a 0 in all samples (no labeling) - removes 13 metabolites
keep <- enrichment_pca_13C %>% select_if(~ is.numeric(.) && sum(as.numeric(.) , na.rm = TRUE) != 0)

also_keep<-enrichment_pca_13C %>%
  select(sample, isotope, treatment, tank, tube)

enrichment_pca_13C<-cbind(also_keep, keep)

enrichment.pca.13C<-prcomp(enrichment_pca_13C[c(6:82)],scale=TRUE, center=TRUE) 
```

```{r}
pcaPlot_enrichment1<-ggplot2::autoplot(enrichment.pca.13C, data=enrichment_pca_13C, frame.colour="treatment",  loadings=FALSE, colour="treatment", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  theme_classic()+
  scale_colour_manual(values=c("blue", "red"))+
  scale_fill_manual(values=c("blue", "red"))+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaPlot_enrichment1

ggsave("Mcap2021/Figures/Metabolomics/enrichment_pca_treatment_13C.jpg", pcaPlot_enrichment1, width=6, height=6)
```

Run PERMANOVA. 
```{r}
# scale data
vegan <- scale(enrichment_pca_13C[c(6:82)])

# PerMANOVA 
permanova<-adonis2(vegan ~ treatment, data = enrichment_pca_13C, method='eu')
permanova
```

Permutation test for adonis under reduced model
Terms added sequentially (first to last)
Permutation: free
Number of permutations: 999

adonis2(formula = vegan ~ treatment, data = enrichment_pca_13C, method = "eu")
          Df SumOfSqs      R2      F Pr(>F)   
treatment  1   193.45 0.22839 2.9599  0.003 **
Residual  10   653.55 0.77161                 
Total     11   847.00 1.00000                 

There appears to be a difference in enrichment by treatment. Investigate this further and see which metabolites are driving the difference with a PLS-DA analysis. 

## Enrichment between light and dark treatments (Methodological control 2) 

We now need to compare enrichment of metabolites between dark and light treatments. We want to verify that photosynthesis-derived metabolites are labeled in the light, but not in the dark. Labeling in the dark would indicate host incorporation of the label rather than the symbiont.   

### Plot enrichment of each metabolite between light and dark isotope treatments    

```{r}
#make summary table
dark_plotting<-plyr::ddply(enrichment, c("Compound", "isotope"), summarise,
                N    = length(enrichment[!is.na(enrichment)]),
                mean = mean(enrichment, na.rm=TRUE),
                sd   = sd(enrichment, na.rm=TRUE),
                se   = sd / sqrt(N)
)

dark_plotting<-dark_plotting%>%arrange(Compound)%>%filter(!isotope=="12C")
```

Plot enrichment for each metabolite for all metabolites.  
```{r}
dark_all_metabolites<-dark_plotting%>%
         
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=isotope, group=isotope)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=isotope), width=0, position=position_dodge(0.9))+
  theme_classic()+
  scale_fill_manual(values=c("lightgreen", "darkblue"))+
  xlab("Metabolites")+
  ylab("Enrichment")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 0.5, hjust=1), 
    axis.title = element_text(face="bold")
    );dark_all_metabolites

ggsave("Mcap2021/Figures/Metabolomics/Controls/enrichment_darkvslight_all.jpg", plot=dark_all_metabolites, width=26, height=8)
```

This shows that the metabolites originating from photosynthsis that we expect to have low label incorporation in the dark do have low label compared to light treatment. For example, glucose, F6P, G6P, and pyruvate have far lower labeling that the light treatment. 

Plot just these metabolites for carbon metabolism. 
```{r}
dark_photo_metabolites<-dark_plotting%>%
  filter(Compound %in% c(c("Glucose", "Fructose-6-phosphate", "Glucose-6-phosphate", "Pyruvate", "Dihydroxyacetone phosphate", "3-Phosphoglycerate", "Lactate", "Ribose phosphate", "Xylose-5-phosphate", "Citrate", "Isocitrate", "a-ketoglutarate", "Succinate", "Malate")))%>%
         
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=isotope, group=isotope)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=isotope), width=0, position=position_dodge(0.9))+
  theme_classic()+
  scale_fill_manual(values=c("lightgreen", "darkblue"))+
  xlab("")+
  ylab("Enrichment")+
  ggtitle("Carbon metabolism")+
  geom_text(x=8, y=0.3, label="All metabolites P<0.001", colour="black", size=5)+
  ylim(0,0.35)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=45, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );dark_photo_metabolites

ggsave("Mcap2021/Figures/Metabolomics/Controls/enrichment_darkvslight_carbon.jpg", plot=dark_photo_metabolites, width=8, height=5)
```

```{r}
dark_ammonia_metabolites<-dark_plotting%>%
  filter(Compound %in% c("Glutamate", "Glutamine", "a-ketoglutarate", "N-acetyl-glutamate", "Citrulline", "Aspartate", "L-arginino-succinate", "Arginine", "Ornithine", "Arginine-Glutamine"))%>%
         
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=isotope, group=isotope)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=isotope), width=0, position=position_dodge(0.9))+
  theme_classic()+
  scale_fill_manual(values=c("lightgreen", "darkblue"))+
  xlab("")+
  ylab("Enrichment")+
  ggtitle("Nitrogen metabolism")+
  geom_text(x=1, y=0.21, label="**", colour="black", size=5)+
  geom_text(x=2, y=0.19, label="**", colour="black", size=5)+
  geom_text(x=3, y=0.13, label="**", colour="black", size=5)+
  geom_text(x=4, y=0.13, label="**", colour="black", size=5)+
  geom_text(x=6, y=0.13, label="**", colour="black", size=5)+
  geom_text(x=7, y=0.11, label="**", colour="black", size=5)+
  geom_text(x=8, y=0.10, label="*", colour="black", size=5)+
  ylim(0,0.3)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=45, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );dark_ammonia_metabolites

ggsave("Mcap2021/Figures/Metabolomics/Controls/enrichment_darkvslight_nitrogen.jpg", plot=dark_ammonia_metabolites, width=8, height=5)
```

GS-GOGAT metabolites are much higher in light. Citrulline and L-arginino-succinate are the only ones with more label in dark. 

Note that these compounds do have some label - but this is expected. The larvae were not dark adapted before the incubations, so the residual label incorporation is likely due to residual photosynthetic and metabolic activity at the start of the dark treatment. Some of the urea cycle metabolites may be due to host uptake - look into this more. 

This is all good news - the metabolites we expect to be labeled through photosynthesis are indeed labeled only in the light. 

Plot these metabolites. 
```{r}
dark_ms_metabolites<-dark_plotting%>%
  filter(Compound %in% c("Methionine sulfoxide"))%>%
         
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=isotope, group=isotope)) + 
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=isotope), width=0, position=position_dodge(0.9))+
  theme_classic()+
  scale_fill_manual(values=c("lightgreen", "darkblue"))+
  scale_x_discrete(labels=c("Methionine \nSulfoxide"))+
  xlab("")+
  ylab("Enrichment")+
  geom_text(x=1, y=0.29, label="**", colour="black", size=5)+
  ylim(0,0.3)+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=45, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );dark_ms_metabolites

ggsave("Mcap2021/Figures/Metabolomics/Controls/enrichment_darkvslight_methioninesulfoxide.jpg", plot=dark_ms_metabolites, width=5, height=5)
```

Calculate average difference in labeling between isotope for these key metabolites. "There was X% decrease in labeling in dark vs light C13 samples."
```{r}
#show for each compound 
enrichment%>%
  group_by(Compound, isotope)%>%
  summarise(mean = mean(enrichment, na.rm=TRUE))%>%
  arrange(Compound)%>%
  filter(Compound %in% control_list)%>%
  group_by(Compound)%>%
  pivot_wider(names_from=isotope, values_from=mean)%>%
  mutate(perc_diff_13vsdark=((`13C`-`Dark-13C`)/`13C`)*100)

enrichment%>%
  group_by(Compound, isotope)%>%
  summarise(mean = mean(enrichment, na.rm=TRUE))%>%
  arrange(Compound)%>%
  filter(Compound %in% c("Glucose", "Fructose-6-phosphate", "Glucose-6-phosphate", "Pyruvate", "Dihydroxyacetone phosphate", "3-Phosphoglycerate", "Lactate", "Ribose phosphate", "Xylose-5-phosphate", "Citrate", "Isocitrate", "a-ketoglutarate", "Succinate", "Malate"))%>%
  group_by(Compound)%>%
  pivot_wider(names_from=isotope, values_from=mean)%>%
  mutate(perc_diff_13vsdark=((`13C`-`Dark-13C`)/`13C`)*100)%>%
  ungroup()%>%
  summarise(mean=mean(perc_diff_13vsdark, na.rm=TRUE), se=sd(perc_diff_13vsdark, na.rm=TRUE)/length(perc_diff_13vsdark))

enrichment%>%
  group_by(Compound, isotope)%>%
  summarise(mean = mean(enrichment, na.rm=TRUE))%>%
  arrange(Compound)%>%
  filter(Compound %in% c("Glutamate", "Glutamine", "a-ketoglutarate", "N-acetyl-glutamate", "Aspartate", "Arginine-Glutamine"))%>%
  group_by(Compound)%>%
  pivot_wider(names_from=isotope, values_from=mean)%>%
  mutate(perc_diff_13vsdark=((`13C`-`Dark-13C`)/`13C`)*100)%>%
  ungroup()%>%
  summarise(mean=mean(perc_diff_13vsdark, na.rm=TRUE), se=sd(perc_diff_13vsdark, na.rm=TRUE)/length(perc_diff_13vsdark))
```

Export mean values for all metabolites in light, C12, and dark. 
```{r}
#show for each compound 
all_dark<-enrichment%>%
  group_by(Compound, isotope)%>%
  summarise(mean = mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/length(enrichment))

write.csv(file="Mcap2021/Output/Metabolomics/dark_vs_light_all_metabolites.csv", all_dark)
```

### ANOVA tests 

Calculate average label for metabolites of interest and then all metabolites by isotope. 
```{r}
enrichment%>%
  filter(Compound %in% control_list)%>%
  filter(!isotope=="12C")%>%
  group_by(isotope)%>%
  summarise(mean = mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/sqrt(length(enrichment)))

#test difference in label by isotope for targets 
test<-enrichment%>%
  filter(!isotope=="12C")%>%
  filter(Compound %in% control_list)%>%
  aov(enrichment~isotope*Compound, data=.)

summary(test)

emm<-emmeans(test, ~isotope | Compound)
pairs(emm)

enrichment%>%
  group_by(isotope)%>%
  summarise(mean = mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/sqrt(length(enrichment)))
```
Ornithine is not significant, Citrulline is not significant, Carbamoyl phosphate has no label, Arginine is not significant. All others are significant. 

## PLSDA and VIP analysis 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X_enrich <- enrichment%>%
  dplyr::select(Compound, isotope, treatment, tank, enrichment)%>%
  filter(isotope=="13C")%>%
  spread(Compound, enrichment) #generate spread data frame

levels(as.factor(X_enrich$treatment))

Y_enrich <- as.factor(X_enrich$treatment) #select treatment names
Y_enrich

X_enrich<-X_enrich[4:93] #pull only data columns

# run PLSDA 
MyResult.plsda_enrich <- plsda(X_enrich,Y_enrich) # 1 Run the method
plotIndiv(MyResult.plsda_enrich)    # 2 Plot the samples
plotVar(MyResult.plsda_enrich, cutoff = 0.7)    

treatment_cols<-c("blue", "red") 
            
pdf("Mcap2021/Figures/Metabolomics/PLSDA_enrichment.pdf", width=9, height=6)
plotIndiv(MyResult.plsda_enrich, col=treatment_cols, ind.names = FALSE, legend=TRUE, legend.title = "Enrichment - C13 Samples", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

#plotIndiv(MyResult.plsda_enrich, col=treatment_cols, ind.names = FALSE, legend=TRUE, legend.title = "Enrichment - C13 Samples", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

Variation between treatment is more than variation within treatment. 

View the VIP metabolites that are most highly differentiating metabolites between treatments. 

```{r}
#extract
enrich_VIP <- PLSDA.VIP(MyResult.plsda_enrich)
enrich_VIP_df <- as.data.frame(enrich_VIP[["tab"]])
enrich_VIP_df

# Converting row names to column
enrich_VIP_table <- rownames_to_column(enrich_VIP_df, var = "Metabolite")

#filter for VIP > 1
enrich_VIP_1 <- enrich_VIP_table %>% 
  filter(VIP >= 1)

#plot
VIP_list_plot_enrich<-enrich_VIP_1 %>%
            arrange(VIP) %>%
  
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Enrichment VIP - C13") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"));VIP_list_plot_enrich

ggsave("Mcap2021/Figures/Metabolomics/VIP_List_enrichment.jpg", VIP_list_plot_enrich, width=4, height=6)

#save VIP values 
enrich_VIP_table %>%
  arrange(VIP) %>%
  write_csv(file="Mcap2021/Output/Metabolomics/VIP_values_enrichment.csv")
```

These lists represent VIPs that drive separation in enrichment by treatment in the 13C samples.  

#### Plot abundance of the VIP metabolites between treatments - enrichment

Filter dataframe by desired metabolites and plot presence in each treatment for enrichment. 
```{r}
enrich_vip_list<-c(enrich_VIP_1$Metabolite)

enrich_vip_metabolites<-enrichment%>%
  filter(Compound %in% enrich_vip_list)%>%
  filter(isotope=="13C")
```

Plot abundance of these metabolites in each sample. 

```{r}
enrich_vip_abund_plot<-enrich_vip_metabolites%>%
  
  ggplot(aes(x=reorder(Compound, -enrichment), y=enrichment, color=treatment, group=treatment))+
  geom_boxplot(aes(group=interaction(Compound, treatment)),position=position_dodge(0.9))+
  geom_point(position=position_jitterdodge(0.2))+
  scale_color_manual(values=c("blue", "red"), name="Treatment")+
  ylab("Enrichment")+
  xlab("VIP Metabolite")+
  ggtitle("VIP Abundance - Enrichment C13")+
  theme_classic()+
  theme(
    axis.text=element_text(color="black", size=12), 
    axis.text.x=element_text(angle=45, hjust=1), 
    axis.title=element_text(color="black", face="bold", size=12),
    plot.margin=margin(1,1,1,1, "cm"),
    legend.text=element_text(size=12),
    legend.title=element_text(size=12, face="bold")
  );enrich_vip_abund_plot

ggsave("Mcap2021/Figures/Metabolomics/VIP_Abundance_Enrichment.jpg", enrich_vip_abund_plot, width=11, height=6)
```

View a table with mean and SE enrichment values for these metabolites at each temperature. 
```{r}
enrich_vip_metabolites_sum<-enrich_vip_metabolites%>%
  group_by(Compound, treatment)%>%
  select(Compound, treatment, enrichment)%>%
  summarise(mean=mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/sqrt(length(enrichment)))%>%
  pivot_longer(cols=mean:se, values_to="value")%>%
  mutate(metric=paste(treatment, "_", name))%>%
  select(Compound, value, metric)%>%
  pivot_wider(names_from=metric, values_from=value)

write.csv(enrich_vip_metabolites_sum, file="Mcap2021/Output/Metabolomics/VIP_Enrichment_Means.csv")
```

View for all metabolites at each temperature (not just VIPs). 
```{r}
enrich_all_metabolites<-enrichment%>%
  filter(isotope=="13C")

enrich_all_metabolites_sum<-enrich_all_metabolites%>%
  group_by(Compound, treatment)%>%
  select(Compound, treatment, enrichment)%>%
  summarise(mean=mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/sqrt(length(enrichment)))%>%
  pivot_longer(cols=mean:se, values_to="value")%>%
  mutate(metric=paste(treatment, "_", name))%>%
  select(Compound, value, metric)%>%
  pivot_wider(names_from=metric, values_from=value)

write.csv(enrich_all_metabolites_sum, file="Mcap2021/Output/Metabolomics/All_Enrichment_Means.csv")
```

Run an ANOVA for the effect of temperature and metabolite on enrichment. 
```{r}
model<-enrichment%>%
  filter(isotope=="13C")%>%
  
  aov(enrichment ~ treatment * Compound, data=.)

summary(model)

emm<-emmeans(model, ~ treatment|Compound)
pairs(emm)

```

Next plot the difference between ambient and high at the treatment level. Negative indicates high is less enriched than ambient, positive indicates high is more enriched than ambient. 

```{r}
enrich_vip_diff_plot<-enrich_vip_metabolites%>%
  arrange(Compound)%>%
  group_by(Compound, treatment)%>%
  summarise(mean=mean(enrichment))%>%
  group_by(Compound)%>%
  reframe(fold_change=(mean-first(mean))/first(mean))%>% #calculate the difference of high from ambient
  filter(fold_change !=0)%>% #remove zero values (comparing ambient to ambient)
  
  ggplot(aes(x=reorder(Compound, -fold_change), y=fold_change, color=factor(ifelse(fold_change>0,"More Enriched in High","More Enriched in Ambient")), group=Compound))+
  geom_bar(stat="identity",position=position_jitterdodge(0.2), fill="white")+
  scale_color_manual(values=c("blue", "red"), name="Treatment")+
  ylab("Enrichment Fold Change")+
  xlab("VIP Metabolite")+
  ggtitle("VIP Difference - C13 Enrichment")+
  theme_classic()+
  ylim(-1.5, 1.5)+
  theme(
    axis.text=element_text(color="black", size=12), 
    axis.text.x=element_text(angle=45, hjust=1), 
    axis.title=element_text(color="black", face="bold", size=12),
    plot.margin=margin(1,1,1,1, "cm"),
    legend.text=element_text(size=12),
    legend.title=element_text(size=12, face="bold")
  );enrich_vip_diff_plot

ggsave("Mcap2021/Figures/Metabolomics/VIP_Difference_Enrichment.jpg", enrich_vip_diff_plot, width=13, height=6)
ggsave("Mcap2021/Figures/Metabolomics/VIP_Difference_Enrichment.pdf", enrich_vip_diff_plot, width=13, height=6)

#export means
enrich_vip_diff_sum<-enrich_vip_metabolites%>%
  arrange(Compound)%>%
  group_by(Compound, treatment)%>%
  summarise(mean=mean(enrichment))%>%
  group_by(Compound)%>%
  summarise(fold_change=(mean-first(mean))/first(mean))%>% #calculate the difference of high from ambient
  filter(fold_change !=0)

write.csv(enrich_vip_diff_sum, file="Mcap2021/Output/Metabolomics/VIP_Enrichment_RelDiff.csv")
```

#### *Metabolites that are more enriched at high temperature:*   

```{r}
test<-enrich_vip_metabolites%>%
  arrange(Compound)%>%
  group_by(Compound, treatment)%>%
  summarise(mean=mean(enrichment))%>%
  group_by(Compound)%>%
  summarise(fold_change=(mean-first(mean))/first(mean))%>% #calculate the difference of high from ambient
  filter(fold_change !=0)%>%
  filter(fold_change>0)%>%
  select(Compound)
```

Adenine           
Alanine           
Arginine-Glutamine
Asparagine        
Aspartate         
Citrulline        
Glutamate         
Glutamine         
Guanine           
Lysine            
Ornithine         
Pantothenate      
Proline           
Taurine           
Valine 

#### *Metabolites that are more enriched at ambient temperature:*   

```{r}
test<-enrich_vip_metabolites%>%
  arrange(Compound)%>%
  group_by(Compound, treatment)%>%
  summarise(mean=mean(enrichment))%>%
  group_by(Compound)%>%
  summarise(fold_change=(mean-first(mean))/first(mean))%>% #calculate the difference of high from ambient
  filter(fold_change !=0)%>%
  filter(fold_change<0)%>%
  select(Compound)
```

3-Phosphoglycerate        
Aconitate                 
Adenosine                 
AMP                       
Citrate                   
Dihydroxyacetone phosphate
Fructose-6-phosphate      
Glucose-6-phosphate       
Glycerol-3-phosphate      
Glycerophosphocholine     
GMP                       
Guanosine                 
Isocitrate                
L-arginino-succinate      
Lactate                   
Leucine                   
NAD+                      
Phenylalanine             
Pyruvate                  
Sorbitol                  
Thymidine                 
Tryptophan                
Tyrosine  

### Plot enrichment for each metabolite  

```{r}
compound_list<-enrichment%>%
  filter(isotope=="13C")%>%
  select(Compound)

compound_list<-c(levels(as.factor(compound_list$Compound)))  

enrichment_plotting<-plyr::ddply(enrichment, c("treatment", "Compound", "isotope"), summarise,
                N    = length(enrichment[!is.na(enrichment)]),
                mean = mean(enrichment, na.rm=TRUE),
                sd   = sd(enrichment, na.rm=TRUE),
                se   = sd / sqrt(N)
)

enrichment_plotting<-enrichment_plotting%>%
  filter(isotope=="13C")
  
# loop through each compound in the list and create a plot
for (compound in compound_list) {
  
  # subset the fractions dataset for the current compound
  compound_data <- subset(enrichment_plotting, Compound == compound)
  
  enrichment.plot <-  ggplot(compound_data, aes(x = treatment, y = mean)) + 
    geom_bar(stat="identity", aes(color=treatment, group=treatment), fill="white", position=position_dodge(), linewidth=1) + 
    scale_color_manual(name="Temperature",values=c("blue", "red"))+
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=treatment), position=position_dodge(0.9), width=0.0, linewidth=1)+
    theme_classic()+
    ggtitle(compound)+
    ylab("Enrichment")+
    xlab("Treatment")+
    theme(
      axis.text=element_text(color="black", size=12), 
      axis.title=element_text(color="black", size=14, face="bold"), 
      legend.text=element_text(color="black", size=12), 
      legend.title=element_text(color="black", size=14, face="bold"), 
      legend.position="none"
    )
  
ggsave(filename=paste0("Mcap2021/Figures/Metabolomics/enrichment_plots/", compound, ".jpeg"), plot=enrichment.plot, width=4, height=4, units="in")

}
```

Plot Glucose specifically. 
```{r}
    glucose.enrichment.plot <-  enrichment_plotting%>%
    filter(Compound=="Glucose")%>%
    
    ggplot(aes(x = treatment, y = mean)) + 
    geom_bar(stat="identity", aes(color=treatment, group=treatment), fill="white", position=position_dodge(), linewidth=1) + 
    scale_color_manual(name="Temperature",values=c("blue", "red"))+
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=treatment), position=position_dodge(0.9), width=0.0, linewidth=1)+
    theme_classic()+
    ylab("Enrichment")+
    xlab("")+
    ylim(0,0.8)+
  
  geom_text(label="VIP<1", x=1.5, y=0.65, size=8, colour="darkgray")+
  
    theme(
      axis.text=element_text(color="black", size=12), 
      axis.title=element_text(color="black", size=14, face="bold"), 
      legend.text=element_text(color="black", size=12), 
      legend.title=element_text(color="black", size=14, face="bold"), 
      legend.position="none"
    );glucose.enrichment.plot
  
ggsave(filename=paste0("Mcap2021/Figures/Metabolomics/glucose_enrichment.jpeg"), plot=glucose.enrichment.plot, width=2.3, height=4, units="in")
```


# Does the number of carbons labeled differ for metabolites of interest between treatments? 

Next, we look at the position of labeling on each metabolite. We will first run a linear model to look for an interaction between metabolite, temperature and location. This will identify metabolites that have differential label location mediated by temperature treatment. 

This information can tell us more about how the molecules were metabolized. 

We will also look at central metabolism metabolites such as glucose, pyruvate, and other relevant compounds. 

## Run linear models 

```{r}
str(fractions)
```

Convert from wide to long format. 
```{r}
fractions<-fractions%>%
  select(!starts_with("Blank"))%>%
  pivot_longer(cols=3:30, names_to="sample", values_to="label")%>%
  separate(sample, c("isotope", "treatment", "tube"), sep="_", remove = FALSE)%>%
  separate(treatment, c("treatment", "tank"), remove = TRUE)%>%
  rename(Position=Label)

#convert to factors 
fractions$Compound<-as.factor(fractions$Compound)
fractions$sample<-as.factor(fractions$sample)
fractions$treatment<-as.factor(fractions$treatment)
fractions$isotope<-as.factor(fractions$isotope)
fractions$tank<-as.factor(fractions$tank)
fractions$tube<-as.factor(fractions$tube)
```

Correct metabolite names.  
```{r}
levels(fractions$Compound)
grep("PosIS", levels(fractions$Compound)) 
grep("NegIS", levels(fractions$Compound)) 
grep("(+HAc)", levels(fractions$Compound)) #3 metabolites with HAc+, need to rename
grep("SIM", levels(fractions$Compound)) 

length(levels(fractions$Compound)) #we have 90 metabolites in our dataset 

fractions<-fractions%>%
  mutate(Compound = str_remove(Compound, pattern=fixed(' (+HAc)')))%>% #rename any with +HAc to remove the +HAc
  mutate(Compound = as.factor(Compound))

fractions<-droplevels(fractions)
length(levels(fractions$Compound))
levels(fractions$Compound) #names are now cleaned
```

Run a mixed effect model in a loop for each compound with sample as a random intercept. We do not want to compare compound, but we are interested in position x treatment effects for each compound separately. 
```{r}
compound_list<-levels(fractions$Compound)
```

First, remove any metabolites that have no label incorporation (0% enrichment in all samples).  
```{r}
zero_metabolites<-c("Carbamoyl phosphate", "Creatinine", "Glycerate", "Hydroxyproline", "Hypotaurine", "Hypoxanthine", "N-Acetylputrescine", "N-carbomoyl-L-aspartate", "NG-dimethyl-L-arginine", "S-adenosyl-L-homocysteine", "Thiamine", "Thymine", "Uric acid")

fraction_position<-fractions%>%
  filter(!Compound %in% zero_metabolites)%>%
  filter(isotope=="13C")%>%
  droplevels()

compound_list<-levels(fraction_position$Compound)
#there are 77 compounds we will analyze that have some labeling incorporation
```

Run linear model in a loop. Run the model to look at labeled number of carbons for labeled metabolites (Position > 0). 

```{r}
#Write a script to run a loop for each compound in compound_list to run a linear mixed effect model with sample as a random intercept and treatment and Position as main effects and output the results to a table 

#Assuming compound_list is a character vector containing the names of your compounds
#Assuming your data is contained in a data frame called "data" with columns "sample", "treatment", "Position", and "response"

#Create an empty data frame to store the results
results_table <- data.frame(Compound = character(),
                            Effect = character(),
                            DF = numeric(),
                            SumSq = numeric(),
                            F_value = numeric(),
                            p_value = numeric())

#Loop over each compound in compound_list
for(compound in compound_list){
  
  #Fit the linear mixed effect model for each compound
  model <- fractions%>%
    filter(Compound==compound)%>%
    filter(isotope=="13C")%>%
    filter(Position>0)%>%
    mutate(Position=as.factor(Position))%>%
    
    aov(label ~ treatment * Position, data = .)

  #Extract the relevant coefficients for interaction of treatment x position
  anova_output <- anova(model)
  coef_summary <- tidy(anova_output)
  coef_summary <- as.data.frame(coef_summary)
  
  #Store the results in the results_table data frame
  results_table <- rbind(results_table, data.frame(Compound = compound,
                                                   Effect = coef_summary["term"],
                                                   DF = coef_summary["df"],
                                                   SumSq = coef_summary["sumsq"],
                                                   F_value = coef_summary["statistic"],
                                                   p_value = coef_summary["p.value"]))
}


results_table<-results_table%>%
  filter(!term=="Residuals")

#apply a p value correction (FDR) for multiple comparisons 
results_table$adj_pvalues <- p.adjust(results_table$p.value, method = "fdr")

#view only p<0.05
results_table_sign<-results_table%>%
  filter(adj_pvalues<0.05)

head(results_table_sign)

write.csv(results_table, file="Mcap2021/Output/Metabolomics/position_enrichment_model_output_full.csv")
```

Run a full model to show the posthoc effects for a metabolite of interest. 
```{r}
model <- fractions%>%
    filter(Compound=="Glucose")%>%
    filter(isotope=="13C")%>%
    filter(Position>0)%>%
    mutate(Position=as.factor(Position))%>%
    
    aov(label ~ treatment * Position, data = .)

emm<-emmeans(model, ~ treatment | Position)
pairs(emm)
```

```{r}
model <- fractions%>%
    filter(Compound=="Aconitate")%>%
    filter(isotope=="13C")%>%
    filter(Position>0)%>%
    mutate(Position=as.factor(Position))%>%
    
    aov(label ~ treatment * Position, data = .)

emm<-emmeans(model, ~ treatment | Position)
pairs(emm)
```

```{r}
model <- fractions%>%
    filter(Compound=="Glucose-6-phosphate")%>%
    filter(isotope=="13C")%>%
    filter(Position>0)%>%
    mutate(Position=as.factor(Position))%>%
    
    aov(label ~ treatment * Position, data = .)

emm<-emmeans(model, ~ treatment | Position)
pairs(emm)
```

```{r}
model <- fractions%>%
    filter(Compound=="Fructose-6-phosphate")%>%
    filter(isotope=="13C")%>%
    filter(Position>0)%>%
    mutate(Position=as.factor(Position))%>%
    
    aov(label ~ treatment * Position, data = .)

emm<-emmeans(model, ~ treatment | Position)
pairs(emm)
```

```{r}
model <- fractions%>%
    filter(Compound=="Pyruvate")%>%
    filter(isotope=="13C")%>%
    filter(Position>0)%>%
    mutate(Position=as.factor(Position))%>%
    
    aov(label ~ treatment * Position, data = .)

emm<-emmeans(model, ~ treatment | Position)
pairs(emm)
```

View the metabolites that have a significant treatment x position interaction:  

```{r}
sign_position_metabolites<-results_table_sign%>%
  filter(adj_pvalues<0.05)%>%
  filter(term=="treatment:Position")

levels(as.factor(sign_position_metabolites$Compound))

write.csv(sign_position_metabolites, file="Mcap2021/Output/Metabolomics/position_enrichment_model_output_sign_interactions.csv")
```

There are 22 metabolites with significant treatment:position interactions. This indicates that some enrichment at a position is modulated by treatments. 

 [1] "Aconitate"                "AMP"                      "Arginine-Glutamine"      
 [4] "Citrulline"               "Fructose-6-phosphate"     "Glucose"                 
 [7] "Glucose-6-phosphate"      "Glutamine"                "Glycerophosphocholine"   
[10] "Guanosine"                "Isocitrate"               "L-arginino-succinate"    
[13] "Leucine"                  "NAD+"                     "Pantothenate"            
[16] "Phenylalanine"            "Pyruvate"                 "Sorbitol"                
[19] "Thymidine"                "Tryptophan"               "UDP-D-Glucose"           
[22] "UDP-N-acetyl-glucosamine"

## Plot label location

Plot label location for compounds of interest to confirm that there is no difference in label position by treatment. 

Run this in a loop and store plots in a folder for each compound.  

First generate means for metabolites with significant interactive effects from above. 
```{r}
# create a vector of compound names
compound_list <- c(levels(as.factor(fraction_position$Compound)))

#calculate means of position label for each treatment
position_plotting<-plyr::ddply(fractions, c("treatment","Position", "Compound", "isotope"), summarise,
                N    = length(label[!is.na(label)]),
                mean = mean(label, na.rm=TRUE),
                sd   = sd(label, na.rm=TRUE),
                se   = sd / sqrt(N)
)

position_plotting<-position_plotting%>%filter(isotope=="13C")%>%arrange(Compound)
```

```{r}
# loop through each compound in the list and create a plot
for (compound in compound_list) {
  
  # subset the fractions dataset for the current compound
  compound_data <- subset(position_plotting, Compound == compound)
  
  compound_data <- compound_data %>%
    filter(!Position==0)
  
  position.plot <-  ggplot(compound_data, aes(x = Position, y = mean)) + 
    geom_bar(stat="identity", aes(color=treatment, group=treatment), fill="white", position=position_dodge(), linewidth=1) + 
    scale_color_manual(name="Temperature",values=c("blue", "red"))+
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=treatment), position=position_dodge(0.9), width=0.0, linewidth=1)+
    theme_classic()+
    ggtitle(compound)+
    ylab("Enrichment")+
    xlab("Number Carbons Labeled")+
    scale_x_continuous(breaks = seq(0, 20, 1))+
    theme(
      axis.text=element_text(color="black", size=12), 
      axis.title=element_text(color="black", size=14, face="bold"), 
      legend.text=element_text(color="black", size=12), 
      legend.title=element_text(color="black", size=14, face="bold"),
      legend.position="none"
    )
  
ggsave(filename=paste0("Mcap2021/Figures/Metabolomics/position_plots/", compound, ".jpeg"), plot=position.plot, width=6, height=4, units="in")

}
```

This generates some nice plots that we can look at! 

In particular, we can look at those with significant position x temperature labeling:  

Arginine-Glutamine
Aspartate
CDP-Choline
Fructose-6-phosphate
Glucose-6-phosphate
Glutamine
Glycerol-3-phosphate
Glycerophosphocholine
Guanine
L-arginino-succinate
Lactate
Leucine
Ornithine
Pantothenate
Phenyllactic acid
Thymidine
Valine
Xylose-5-phosphate

We can look at the specific labeling patterns in the plots to see if there is a difference in the number of carbons labeled. 

For example, in aconitate, there is higher labeling on 1 carbon at high temperature, but equal or slightly higher label at ambient temperature on 2-6 carbons. In fructose-6-phosphate, labeling is higher in 1-3 carbons at ambient, but equal in 4-6 carbons. 

Glucose is particularly interesting. The distribution of labeling is shifted to the right at higher temperature than ambient. Since we are interested in this metabolite specifically, plot it separately. 

```{r}
# subset the fractions dataset for the current compound
glucose.position.plot <- position_plotting %>%
    filter(isotope=="13C")%>%
    filter(!Position==0)%>%
    filter(Compound=="Glucose")%>%
  
    ggplot(aes(x = Position, y=mean, fill=treatment, color=treatment)) + 
    geom_bar(stat="identity", aes(color=treatment, group=treatment), fill="white", position=position_dodge(), linewidth=1) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=treatment), position=position_dodge(0.9), width=0.0, linewidth=1, color="black")+
    scale_color_manual(name="Temperature",values=c("blue", "red"))+
    theme_classic()+
    ylab("Enrichment")+
    xlab("Number Carbons Labeled")+
    scale_x_continuous(breaks = seq(0, 20, 1))+
  
    geom_text(label="CxT=0.004", x=4, y=0.3, color="black", size=6)+
    geom_text(label="**", x=1, y=0.085, color="black", size=6)+
    geom_text(label="*", x=2, y=0.115, color="black", size=6)+
  
    ylim(0,0.35)+
  
    theme(
      axis.text=element_text(color="black", size=12), 
      axis.title=element_text(color="black", size=14, face="bold"), 
      legend.text=element_text(color="black", size=12), 
      legend.title=element_text(color="black", size=14, face="bold"),
      legend.position="none"
    );glucose.position.plot

ggsave(filename="Mcap2021/Figures/Metabolomics/glucose_enrichment_position.jpeg", plot=glucose.position.plot, width=6, height=4, units="in")

#view means
position_plotting %>%
    filter(isotope=="13C")%>%
    #filter(!Position==0)%>%
    filter(Compound=="Glucose")%>%
    arrange(Position)
```

Plot instead as a smooth line. 
```{r}
# subset the fractions dataset for the current compound
glucose.position.plot2 <- fractions %>%
    filter(isotope=="13C")%>%
    filter(!Position==0)%>%
    filter(Compound=="Glucose")%>%
  
    ggplot(aes(x = Position, y=label, fill=treatment, color=treatment)) + 
    geom_smooth(stat="smooth", aes(group=treatment), se=FALSE, linewidth=1.5)+
    scale_color_manual(name="Temperature",values=c("blue", "red"))+
    theme_classic()+
    ggtitle("Glucose")+
    ylab("Enrichment")+
    xlab("Number Carbons Labeled")+
    scale_x_continuous(breaks = seq(0, 20, 1))+
    theme(
      axis.text=element_text(color="black", size=12), 
      axis.title=element_text(color="black", size=14, face="bold"), 
      legend.text=element_text(color="black", size=12), 
      legend.title=element_text(color="black", size=14, face="bold"),
      legend.position="none"
    );glucose.position.plot2
  

```

# Correlations between pool size and enrichment and relationships between change in enrichment and change in pool size   

Next, examine turnover in metabolites by plotting the expected vs observed for difference in pool size compared to 1) difference in enrichment and 2) difference in labeling for each metabolite (high vs ambient). 

## Assemble master dataframe 

Make a wide and long format of the master data frame assembled from pool_size, enrichment, and prop_fractions dataframes.   
```{r}
master<-left_join(pool_size, enrichment)
master<-master%>%
  filter(isotope=="13C")

master<-master%>%
  select(!isotope)%>%
  select(!tank)%>%
  select(!tube)

head(master)
master$sample<-as.factor(master$sample)

str(master)
```

We have 90 metabolites, 12 samples, and 2 treatments, as expected. 

Next create a master_wide data frame in order to calculate relative change in pool size, enrichment, and labeling for each metabolite between high and ambient temperatures. We can the plot both raw values and relative change values.  

```{r}
master_treatment<-master%>%
  select(!intensity.norm)%>%
  group_by(Compound, treatment)%>%
  summarize(mean_log.intensity.norm = mean(log.intensity.norm, na.rm=TRUE),
            mean_enrichment = mean(enrichment, na.rm=TRUE))%>%
  pivot_wider(names_from=treatment, values_from=(c(mean_log.intensity.norm, mean_enrichment)))%>%
  mutate(change_pool=((mean_log.intensity.norm_High-mean_log.intensity.norm_Ambient)/mean_log.intensity.norm_Ambient),
         change_enrichment=((mean_enrichment_High-mean_enrichment_Ambient)/mean_enrichment_Ambient))
```

We will have NA's in change values for enrichment and labeling in metabolites that do not have any label incorporation as expected.  

## Correlations

### Pool size vs enrichment 

Plot correlation between the raw values of pool size and enrichment, colored by treatment. 

```{r}
pool_vs_enrichment_correlation<-master%>%
  
  ggplot(aes(x=log.intensity.norm, y=enrichment, color=treatment))+
  geom_point()+
  stat_smooth(geom="smooth", method="lm")+
  scale_color_manual(values=c("blue", "red"))+
  theme_classic();pool_vs_enrichment_correlation
```

I do not see overall differences in the relationship between pool size and enrichment in all metabolites as a whole. 

Plot this relationship for each metabolite individually. 
```{r}
metabolite_list<-c(levels(master$Compound))

for (metabolite in metabolite_list){
  
  #generate a plot
  
  plot <-  master%>%
    filter(Compound==metabolite)%>%
    
    ggplot(aes(x=log.intensity.norm, y=enrichment, color=treatment))+
    geom_point(size=4)+
    ggtitle(metabolite)+
    xlab("log(normalized pool size)")+
    ylab("Enrichment")+
    scale_color_manual(values=c("blue", "red"), name="Temperature")+
    theme_classic()+
  theme(
      axis.text=element_text(size=12, color="black"),
      axis.title=element_text(size=12, color="black", face="bold"),
      legend.position="none"
    )
  
  #save the plot
  ggsave(paste0("Mcap2021/Figures/Metabolomics/metabolite_pool_vs_enrichment/", metabolite, ".jpeg"), plot=plot, width=5, height=5)
  
}

```

## Relative change and turnover 

### Pool size vs enrichment change 

Plot relative change pool size vs enrichment of each metabolite.  

```{r}
pool_vs_enrichment_change<-master_treatment%>%
  ggplot(aes(x=change_pool, y=change_enrichment, color=factor(ifelse(change_enrichment>0,"Greater in High","Greater in Ambient"))))+
  geom_point()+
  ylim(-6, 25)+
  xlim(-0.75,2.2)+
  scale_color_manual(breaks=c("Greater in Ambient", "Greater in High"),values=c("blue", "red"), name="Enrichment Pattern", drop=TRUE)+
  geom_hline(yintercept=0, linetype="dashed")+
  geom_vline(xintercept=0, linetype="dashed")+
  #geom_abline(intercept = 0, slope = 1, color="red")+
  geom_text(aes(label=ifelse(abs(change_enrichment)>1,as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  geom_text(aes(label=ifelse(abs(change_pool)>0.5,as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  theme_classic()+
  geom_text(x=-0.45, y=25, label="More abundant \nat Ambient", color="black", size=4)+
  geom_text(x=1.1, y=25, label="More abundant \nat High", color="black", size=4)+
  geom_text(x=-0.75, y=-3.5, label="More enriched \nat Ambient", color="blue", size=4, angle=90)+
  geom_text(x=-0.75, y=12, label="More enriched \nat High", color="red", size=4, angle=90)+
  ylab("Relative Change in Enrichment")+
  xlab("Relative Change in Pool Size")+
  theme(
    legend.position="none",
    axis.text=element_text(size=14, color="black"),
    axis.title=element_text(size=14, color="black", face="bold")
  );pool_vs_enrichment_change

ggsave("Mcap2021/Figures/Metabolomics/change_enrichment_vs_poolsize.jpeg", plot=pool_vs_enrichment_change, width=8, height=6)
```
We can use this plot to look at metabolites that are higher/lower in enrichment relative to changes in pool size. This can tell us more about turnover. For example, we expect higher turnover in metabolites that have more label incorporation, but stay at a similar pool size. An example of this is Montiporic Acid C, which is highly enriched but doesn't change much in pool size. Theanine, CMP, and Phenyllactic acid show similar trends. 

Plot without Montiporic Acids. 

```{r}
pool_vs_enrichment_change2<-master_treatment%>%
  filter(!Compound=="Montiporic Acid C")%>%
  
  ggplot(aes(x=change_pool, y=change_enrichment, color=factor(ifelse(change_enrichment>0,"Greater in High","Greater in Ambient"))))+
  geom_point()+
  ylim(-6, 8)+
  xlim(-0.75,2.2)+
  scale_color_manual(breaks=c("Greater in Ambient", "Greater in High"),values=c("blue", "red"), name="Enrichment Pattern", drop=TRUE)+
  geom_hline(yintercept=0, linetype="dashed")+
  geom_vline(xintercept=0, linetype="dashed")+
  #geom_abline(intercept = 0, slope = 1, color="red")+
  geom_text(aes(label=ifelse(abs(change_enrichment)>1,as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  geom_text(aes(label=ifelse(abs(change_pool)>0.7,as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  #geom_text(aes(label=ifelse(change_pool< -0.2,as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  #geom_text(aes(label=ifelse(Compound=="Glucose",as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  #geom_text(aes(label=ifelse(Compound=="Arginine-Glutamine",as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  #geom_text(aes(label=ifelse(Compound=="Pyruvate",as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  #geom_text(aes(label=ifelse(Compound=="Glucose-6-phosphate",as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  #geom_text(aes(label=ifelse(Compound=="Fructose-6-phosphate",as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  #geom_text(aes(label=ifelse(Compound=="Glutamine",as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  #geom_text(aes(label=ifelse(Compound=="Glutamate",as.character(Compound),'')),hjust=-0.1,vjust=0, color="black")+
  theme_classic()+
  geom_text(x=-0.45, y=8, label="More abundant \nat Ambient", color="black", size=4)+
  geom_text(x=1.1, y=8, label="More abundant \nat High", color="black", size=4)+
  geom_text(x=-0.75, y=-3.5, label="More enriched \nat Ambient", color="black", size=4, angle=90)+
  geom_text(x=-0.75, y=4, label="More enriched \nat High", color="black", size=4, angle=90)+
  ylab("Relative Change in Enrichment")+
  xlab("Relative Change in Pool Size")+
  theme(
    legend.position="none",
    axis.text=element_text(size=14, color="black"),
    axis.title=element_text(size=14, color="black", face="bold")
  );pool_vs_enrichment_change2

ggsave("Mcap2021/Figures/Metabolomics/change_enrichment_vs_poolsize_noacids.jpeg", plot=pool_vs_enrichment_change2, width=8, height=6)
ggsave("Mcap2021/Figures/Metabolomics/change_enrichment_vs_poolsize_noacids.pdf", plot=pool_vs_enrichment_change2, width=8, height=6)

#view the coordinates for manual labeling 
table<-master_treatment%>%
  select(Compound, change_pool, change_enrichment)%>%
  filter(Compound %in% c("Glucose", "Glucose-6-phosphate", "Fructose-6-phosphate", "Pyruvate", "Glutamine", "Glutamate", "Citrulline", "Citrate", "Aspartate", "Arginine-Glutamine"));table
```
