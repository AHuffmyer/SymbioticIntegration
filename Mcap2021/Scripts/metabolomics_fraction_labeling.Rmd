---
title: Montipora capitata 2021 thermal stress metabolomics analysis - isotopic labeling 
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

# Set up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("factoextra" %in% rownames(installed.packages()) == 'FALSE') install.packages('factoextra') 
if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify') 
if ("naniar" %in% rownames(installed.packages()) == 'FALSE') install.packages('naniar') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics") 
if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire') 
if ("VennDiagram" %in% rownames(installed.packages()) == 'FALSE') install.packages('VennDiagram') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 

#load packages
library("ggplot2")
library('vegan')
library('factoextra')
library('ggfortify')
library('naniar')
library('cowplot')
library("mixOmics")
library("tidyverse")
library("RVAideMemoire")
library("VennDiagram")
library("broom")
library("lme4")
library("lmerTest")

```

This script processes and prepares metabolomics isotopic labeling data for analysis and conducts multivariate visualizations. 

# Load data 

Load fraction labeling data.  

```{r}
labels<-read_csv("Mcap2021/Data/Metabolomics/Fractions.csv")
```

Format data to long format and add metadata information from sample name.    

```{r}
labels<-labels%>%
  select(!starts_with("Blank"))%>%
  pivot_longer(cols=3:30, names_to="sample", values_to="label")%>%
  separate(sample, c("isotope", "temperature", "tank","tube"), remove = FALSE)
```

# Label vs no label 

## Calculate summary of label vs no label 

Summarize data to show proprtion of metabolites with no labeling (label = 0) and any other labeling (label > 0). We will return to position specific labeling later on. Calculate ratio of label to no label. 

```{r}
proportions<-labels%>%
  mutate(category=if_else(Label==0, "nolabel", "label"))%>%
  filter(category=="label")%>%
  group_by(Compound, sample, isotope, temperature, tank, tube)%>%
  summarise(mean_label=mean(label, na.rm=TRUE))
  
```

## Analysis 

```{r}
model<-proportions%>%
  
  lmer(mean_label~Compound * isotope * temperature + (1|sample), data=.)

anova(model)
```

There is an interaction between compound, isotope, and temperature. 

```{r}
model2<-proportions%>%
  filter(isotope=="13C")%>%
  
  lmer(mean_label~Compound*temperature + (1|sample), data=.)

anova(model2)
summary(model2)
```
There is an interaction between temperature and total labeling in 13C samples at high temperature. 

Lower labeling at high temperature.  
- Pyruvate
- Lactate
- L-arginino-succinate
- Glycerol-3-phosphate
- Dihydroxyacetone phosphate

Increased labeling at high temperature:
- Methionine sulfoxide
- Guanine
- Gluatmine
- Citrulline
- Asparagine
- Arginine-glutamine
- Xylose-5-phosphate

## Plotting 

View the labeling information for all isotope treatments. 

```{r}
#make summary table
data_plotting<-plyr::ddply(proportions, c("isotope", "temperature", "Compound"), summarise,
                N    = length(mean_label[!is.na(mean_label)]),
                mean = mean(mean_label, na.rm=TRUE),
                sd   = sd(mean_label, na.rm=TRUE),
                se   = sd / sqrt(N)
)

data_plotting<-data_plotting%>%arrange(Compound)

metab_compounds<-ggplot(data_plotting, aes(y=mean, x=Compound, fill=temperature, group=temperature)) + 
  facet_grid(~isotope)+
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  theme_classic()+
  xlab("Metabolite")+
  scale_fill_manual(values=c("lightblue", "red3"))+
  ylab("Proportion metabolites labeled")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );metab_compounds
```

## Plot metabolites that differ in labeling between temperatures from 13C samples 

(analysis from above) 

Lower labeling at high temperature.  
- Pyruvate
- Lactate
- L-arginino-succinate
- Glycerol-3-phosphate
- Dihydroxyacetone phosphate

Increased labeling at high temperature:
- Methionine sulfoxide
- Guanine
- Gluatmine
- Citrulline
- Asparagine
- Arginine-glutamine
- Xylose-5-phosphate

```{r}
list<-c("Pyruvate", "Lactate", "L-arginino-succinate", "Glycerol-3-phosphate", "Dihydroxyacetone phosphate", "Methionine sulfoxide", "Guanine", "Glutamine", "Citrulline", "Asparagine", "Arginine-Glutamine", "Xylose-5-phosphate")

plot_selected_labels<-data_plotting%>%
  filter(Compound %in% list)%>%
  filter(isotope=="13C")%>%
  
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=temperature, group=temperature)) + 
  facet_grid(~isotope)+
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=temperature), width=0.1, position=position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values=c("lightblue", "red3"))+
  xlab("Metabolite")+
  ylab("Proportion total labeling")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );plot_selected_labels
```

```{r}
plot_selected_labels_12c<-data_plotting%>%
  filter(Compound %in% list)%>%
  filter(isotope=="12C")%>%
  
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=temperature, group=temperature)) + 
  facet_grid(~isotope)+
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=temperature), width=0.1, position=position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values=c("lightblue", "red3"))+
  xlab("Metabolite")+
  ylab("Proportion total labeling")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );plot_selected_labels_12c
```
Low labeling in 12C (basically none, one weird one adding noise). 

```{r}
plot_selected_labels_dark<-data_plotting%>%
  filter(Compound %in% list)%>%
  filter(isotope=="Dark13C")%>%
  
  ggplot(., aes(y=mean, x=reorder(Compound, -mean), fill=temperature, group=temperature)) + 
  facet_grid(~isotope)+
  geom_bar(stat="identity", position=position_dodge())+ #change to change boxplot width
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=temperature), width=0.1, position=position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values=c("lightblue", "red3"))+
  xlab("Metabolite")+
  ylab("Proportion total labeling")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, size=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );plot_selected_labels_dark
```
Some labeling in dark 13C, need to examine this closer. 

# Plot stacked bar plot of labeling fractions for the metabolites that are different by treatment. 

```{r}
labels_stack<-labels%>%
  mutate(category=if_else(Label==0, "nolabel", "label"))%>%
  select(!Label)%>%
  group_by(Compound, isotope, temperature, category)%>%
  summarise(label_mean=mean(label, na.rm=TRUE))
```

Plot each compound in stacked bar plots for 13C samples.
```{r}
stacked_plot<-labels_stack%>%
  filter(isotope=="13C")%>%
  
ggplot(., aes(x = temperature, y = label_mean, fill = category)) +
  facet_wrap(~Compound)+
  scale_fill_manual(values=c("red3", "darkgray"))+
  geom_bar(stat = "identity") +
  labs(title = "Stacked bar plot", x = "Compound", y = "Labeling", fill = "Label Pattern");stacked_plot
```

Plot the differential metabolites identified in models above. 
```{r}
stacked_plot_selected<-labels_stack%>%
  filter(isotope=="13C")%>%
  filter(Compound %in% list)%>%
  
ggplot(., aes(x = temperature, y = label_mean, fill = category)) +
  facet_wrap(~Compound)+
  scale_fill_manual(values=c("red3", "darkgray"))+
  geom_bar(stat = "identity") +
  labs(title = "13C", x = "Compound", y = "Labeling", fill = "Label Pattern")+
  theme_classic();stacked_plot_selected
```

No labeling in 12 C. 
```{r}
stacked_plot_selected_12c<-labels_stack%>%
  filter(isotope=="12C")%>%
  filter(Compound %in% list)%>%
  
ggplot(., aes(x = temperature, y = label_mean, fill = category)) +
  facet_wrap(~Compound)+
  scale_fill_manual(values=c("red3", "darkgray"))+
  geom_bar(stat = "identity") +
  labs(title = "12C", x = "Compound", y = "Labeling", fill = "Label Pattern")+
  theme_classic();stacked_plot_selected_12c
```

Some labeling in Dark 13C.   
```{r}
stacked_plot_selected_dark<-labels_stack%>%
  filter(isotope=="Dark13C")%>%
  filter(Compound %in% list)%>%
  
ggplot(., aes(x = temperature, y = label_mean, fill = category)) +
  facet_wrap(~Compound)+
  scale_fill_manual(values=c("red3", "darkgray"))+
  geom_bar(stat = "identity") +
  labs(title = "Dark 13C", x = "Compound", y = "Labeling", fill = "Label Pattern")+
  theme_classic();stacked_plot_selected_dark
```

# Questions

How should we analyze total ion counts? 
How should we correct for Dark 13C counts? 
How should we use 12C counts? Do we need to use 13C and 12C together?
How do we analyze position labeling?
Best way to represent proportion labeling? 

What does more labeling indicate? 

Matthews 2018: Proportion metabolite abundance of 12C and 13C metabolites 
Hillyer 2018: Label as fraction of total pool

Labeling of some compounds would suggest that the host is taking up inorganic carbon to generate these molecules (e.g., methiodinine sulfoxide). Is this the same for others? How does this work? 

Differential labeling of lactate, pyruvate, amino acids would suggest symbiont sourced carbon. 

We seem to have pretty minor differences in labeling. Is this what we would expect? 

In Dark 13C there seem to be some differences at temperature - what is driving this? What metabolites would we expect to see host uptake of inorganic carbon for synthesis?









